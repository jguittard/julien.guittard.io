<!DOCTYPE html><html lang=en xml:lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=Content-Type content="text/html; charset=UTF-8"><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=0"><meta name=theme-color content=#70b49c><meta name=msapplication-navbutton-color content=#70b49c><meta name=apple-mobile-web-app-status-bar-style content=black-translucent><meta name=mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-capable content=yes><meta name=application-name content="Julien Guittard"><meta name=apple-mobile-web-app-title content="Julien Guittard"><meta name=msapplication-starturl content=/ ><link rel=canonical itemprop=url href=https://julien.guittard.io/blog/serve-psr-7-middleware-via-react.html><link rel=alternate type=application/rss+xml title=RSS href=/feed.xml><title>Julien Guittard &nbsp;|&nbsp;Serve PSR-7 Middleware Via React</title><meta name=author itemprop=author content="Julien Guittard"><link rel=author href="http://google.com/+JulienGuittardWebpage?rel=author"><meta name=description itemprop=description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta property=og:locale content=en_US><meta property=og:type content=article><meta property=og:title content="Serve PSR-7 Middleware Via React"><meta property=og:url content=https://julien.guittard.io/blog/serve-psr-7-middleware-via-react.html><meta property=og:image content=https://julien.guittard.io/thumbs/ ><meta property=og:site_name content="Julien Guittard"><meta property=article:publisher content=http://www.facebook.com/julien.guittard><meta property=article:author content=https://www.facebook.com/julien.guittard><meta property=article:published_time content=2016-04-17T15:00:00-04:00><meta property=og:description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Serve PSR-7 Middleware Via React"><meta name=twitter:description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta name=twitter:site content=@julienguittard><meta name=twitter:creator content=@julienguittard><meta name=twitter:card content=summary><link rel=manifest href=/manifest.json><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon href=/icons/icon-128.png><link rel=icon href=/icons/icon-192.png><link rel=icon href=/icons/icon-120.png><link rel=icon href=/icons/icon-120.png sizes=120x120><link rel=icon href=/icons/icon-152.png sizes=152x152><link rel=icon href=/icons/icon-167.png sizes=167x167><link rel=icon href=/icons/icon-180.png sizes=180x180><link rel=stylesheet type=text/css href=/styles/main.css><!--[if lt IE 9]>
  	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  	<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]--><script type=text/javascript>WebFontConfig={google:{families:["Open+Sans:300,400,700:latin","Lato:700,900:latin"]}},function(){var t=document.createElement("script");t.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",t.type="text/javascript",t.async="true";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></head><body itemscope itemtype=https://schema.org/WebPage><header class="header push-down-45" role=banner itemscope itemtype=http://schema.org/WPHeader><div class=container><div class="logo pull-left" itemprop=publisher itemscope id=jg-organization itemtype=https://schema.org/Organization><a href=/ rel=home itemprop=url><span itemprop=logo itemscope itemtype=https://schema.org/ImageObject><img itemprop=contenturl src=https://julien.guittard.io/images/logo.png alt=JG width=352 height=140><meta itemprop=width content=352><meta itemprop=height content=140><meta itemprop=url content=https://julien.guittard.io/images/logo.png></span><meta itemprop=name content="Julien Guittard"></a></div><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#top-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button></div><nav class="navbar navbar-default" role=navigation><div class="collapse navbar-collapse" id=top-navbar-collapse><ul class=navigation role=menu itemscope itemtype=http://www.schema.org/SiteNavigationElement><li role=menuitem><a href=https://julien.guittard.io/ itemprop=url><span itemprop=name>Home</span></a></li><li role=menuitem><a href=https://julien.guittard.io/blog/ itemprop=url><span itemprop=name>Blog</span></a></li><li role=menuitem><a href=https://julien.guittard.io/about-me/ itemprop=url><span itemprop=name>About me</span></a></li><li role=menuitem><a href=https://julien.guittard.io/contact/ itemprop=url><span itemprop=name>Contact</span></a></li></ul></div></nav><div class="hidden-xs hidden-sm"><a href=# class="search__container js--toggle-search-mode"><span class="glyphicon glyphicon-search"></span></a><div class=social><a href=# class=social__container><span class="glyphicon glyphicon-heart"></span></a><ul class=social__dropdown><li><a href=https://www.twitter.com/julienguittard target=_blank class=social__container title="Follow me on Twitter"><span class=zocial-twitter></span></a></li><li><a href=https://www.linkedin.com/in/julienguittard target=_blank class=social__container title="Hire me on LinkedIn"><span class=zocial-linkedin></span></a></li><li><a href=https://github.com/jguittard target=_blank class=social__container title="Clone me on Github"><span class=zocial-github></span></a></li><li><a href=/feed.xml target=_blank class=social__container title="Read me through RSS"><span class=zocial-rss></span></a></li></ul></div></div></div></header><div class=search-panel><div class=container><div class=row><div class=col-xs-12><form action=/search itemprop=potentialAction itemscope itemtype=https://schema.org/SearchAction><meta itemprop=target content="https://julien.guittard.io/search?q="><input itemprop=query-input type=search name=q class="search-panel__form js--search-panel-text" placeholder="Begin typing for search"><p class=search-panel__text>Press enter to see results or esc to cancel.</p></form></div></div></div></div><div class=container><article class="boxed push-down-60" itemscope itemtype=http://schema.org/BlogPosting itemref=jg-organization><link itemprop=mainEntityOfPage href=https://julien.guittard.io/blog/serve-psr-7-middleware-via-react.html><header class=meta><div class=row><div class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2"><div class=meta__container--without-image><div class=row><div class="col-xs-12 col-sm-8"><div class=meta__info><span class=meta__author role=contentinfo itemprop=author itemscope itemtype=http://schema.org/Person><figure itemprop=image itemscope itemtype=http://schema.org/ImageObject><img src="https://avatars2.githubusercontent.com/u/5320213?s=90&v=4" alt="Author avatar" width=30 height=30><meta itemprop=width content=30><meta itemprop=height content=30></figure><a href=/about target=_blank rel=author itemprop=url><span itemprop=name>Julien</span> </a>in <a href=/blog/categories/web/ >Web</a> </span><span class=meta__date role=contentinfo><span class="glyphicon glyphicon-calendar"></span> &nbsp; <time itemprop=datePublished datetime=2016-04-17T15:00:00-04:00>April 17, 2016</time><meta itemprop=dateModified content=2016-04-17T15:00:00-04:00></span></div></div><div class="col-xs-12 col-sm-4"><div class=meta__comments><span class="glyphicon glyphicon-comment"></span> &nbsp; <a href=/blog/serve-psr-7-middleware-via-react.html#disqus_thread data-disqus-identifier=/blog/serve-psr-7-middleware-via-react.html>Comments</a></div></div></div></div></div></div></header><div class=row><div class="col-xs-10 col-xs-offset-1 col-md-8 col-md-offset-2 push-down-60"><section class=post-content><h1 itemprop=headline>Serve PSR-7 Middleware Via React</h1><h3 itemprop=description>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor.</h3><div itemprop=articleBody><p>I’ve been intending to play with <a href=http://reactphp.org>React</a> for some time, but, for one reason or another, kept putting it off. This past week, I carved some time finally to experiment with it, and, specifically, to determine if serving <a href=http://www.php-fig.org/psr/psr-7>PSR-7</a> middleware was possible.</p><h2 id=react>React</h2><p>For those of you unfamiliar with it, React is a project with the goal of providing event-driven, asynchronous PHP, in a vein similar to <a href=https://nodejs.org>node.js</a>. To accomplish this, it makes use of one of several experimental extensions, falling back to PHP’s built-in <code class=highlighter-rouge>tick()</code> support and stream utilities. The project provides the event loop implementation; a Promises library; a cross-platform, low-level socket library; an HTTP server; and several other libraries.</p><p>The library that most associate with React, though, is the HTTP server. This library is in the same vein as node’s <a href=https://nodejs.org/api/http.html>HTTP</a> module, which provides the low-level plumbing for creating HTTP servers.</p><p>A basic server looks like this:</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$app</span> <span class=o>=</span> <span class=k>function</span> <span class=p>(</span><span class=nv>$request</span><span class=p>,</span> <span class=nv>$response</span><span class=p>)</span> <span class=p>{</span>
    <span class=nv>$response</span><span class=o>-&gt;</span><span class=na>writeHead</span><span class=p>(</span><span class=mi>200</span><span class=p>,</span> <span class=k>array</span><span class=p>(</span><span class=s1>'Content-Type'</span> <span class=o>=&gt;</span> <span class=s1>'text/plain'</span><span class=p>));</span>
    <span class=nv>$response</span><span class=o>-&gt;</span><span class=na>end</span><span class=p>(</span><span class=s2>"Hello World</span><span class=se>\n</span><span class=s2>"</span><span class=p>);</span>
<span class=p>};</span>

<span class=nv>$loop</span> <span class=o>=</span> <span class=nx>React\EventLoop\Factory</span><span class=o>::</span><span class=na>create</span><span class=p>();</span>
<span class=nv>$socket</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>React\Socket\Server</span><span class=p>(</span><span class=nv>$loop</span><span class=p>);</span>
<span class=nv>$http</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>React\Http\Server</span><span class=p>(</span><span class=nv>$socket</span><span class=p>,</span> <span class=nv>$loop</span><span class=p>);</span>

<span class=nv>$http</span><span class=o>-&gt;</span><span class=na>on</span><span class=p>(</span><span class=s1>'request'</span><span class=p>,</span> <span class=nv>$app</span><span class=p>);</span>
<span class=k>echo</span> <span class=s2>"Server running at http://127.0.0.1:1337</span><span class=se>\n</span><span class=s2>"</span><span class=p>;</span>

<span class=nv>$socket</span><span class=o>-&gt;</span><span class=na>listen</span><span class=p>(</span><span class=mi>1337</span><span class=p>);</span>
<span class=nv>$loop</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>();</span>
</code></pre></div></div><p>What I wanted to do was get React to execute PSR-7 middleware, specifically an <a href=https://zendframework.github.io/zend-expressive>Expressive</a> application.</p><h2 id=translating-react-to-psr-7>Translating React to PSR-7</h2><p>React provides its own request and response implementations. As noted, these are very much aligned with node, down to the level that each is a stream, with additional methods based on the message type. If you’ve played with node at all, React’s HTTP layer will feel very familiar.</p><p>The problem, though, is that the messages differ from PSR-7; you can’t just pass them into middleware expecting PSR-7 and have everything work. So, a translation layer was required.</p><p>This boiled down to two tasks:</p><ul><li>Marshaling a PSR-7 request instance from the React request.</li><li>Pulling information from the PSR-7 response returned by middleware, and using that information to populate and write to the React response.</li></ul><p>I discovered quickly that the latest stable release and the current master branch of react/http differ significantly. In particular, the current master branch offers a number of new features, such as URL discovery and file upload handling, which make generating the PSR-7 request far easier. In the end, the logic becomes something like this:</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$body</span> <span class=o>=</span> <span class=nb>fopen</span><span class=p>(</span><span class=s1>'php://temp'</span><span class=p>,</span> <span class=s1>'w+'</span><span class=p>);</span>
<span class=nb>fwrite</span><span class=p>(</span><span class=nv>$body</span><span class=p>,</span> <span class=nv>$reactRequest</span><span class=o>-&gt;</span><span class=na>getBody</span><span class=p>());</span>
<span class=nb>fseek</span><span class=p>(</span><span class=nv>$body</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span> <span class=c1>// Rewind the stream
</span>
<span class=k>return</span> <span class=k>new</span> <span class=nx>Zend\Diactoros\ServerRequest</span><span class=p>(</span>
    <span class=nv>$_SERVER</span><span class=p>,</span>
    <span class=nv>$reactRequest</span><span class=o>-&gt;</span><span class=na>getFiles</span><span class=p>(),</span>
    <span class=nv>$reactRequest</span><span class=o>-&gt;</span><span class=na>getUrl</span><span class=p>(),</span>
    <span class=nv>$reactRequest</span><span class=o>-&gt;</span><span class=na>getMethod</span><span class=p>(),</span>
    <span class=nv>$body</span><span class=p>,</span>
    <span class=nv>$reactRequest</span><span class=o>-&gt;</span><span class=na>getHeaders</span><span class=p>(),</span>
    <span class=p>[],</span> <span class=c1>// cookies; these can be handled by PSR-7 middleware
</span>    <span class=nv>$reactRequest</span><span class=o>-&gt;</span><span class=na>getQuery</span><span class=p>(),</span>
    <span class=nv>$reactRequest</span><span class=o>-&gt;</span><span class=na>getPost</span><span class=p>(),</span>
    <span class=nv>$reactRequest</span><span class=o>-&gt;</span><span class=na>getHttpVersion</span><span class=p>()</span>
<span class=p>);</span>
</code></pre></div></div><p>Handling the response can be relatively simple:</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$reactResponse</span><span class=o>-&gt;</span><span class=na>writeHead</span><span class=p>(</span>
    <span class=nv>$psr7Response</span><span class=o>-&gt;</span><span class=na>getStatusCode</span><span class=p>(),</span>
    <span class=nv>$psr7Response</span><span class=o>-&gt;</span><span class=na>getHeaders</span><span class=p>()</span>
<span class=p>);</span>
<span class=nv>$reactResponse</span><span class=o>-&gt;</span><span class=na>end</span><span class=p>((</span><span class=nx>string</span><span class=p>)</span> <span class=nv>$psr7Response</span><span class=o>-&gt;</span><span class=na>getBody</span><span class=p>())</span>
</code></pre></div></div><p>That said, I found it was useful to perform a few additional things:</p><ul><li>If no content type is set, set it to <code class=highlighter-rouge>text/html</code>.</li><li>Rewind the PSR-7 response body before retrieving it. I’ve occasionally observed truncated content otherwise.</li><li>Close the PSR-7 response body when done. This will close the underlying resource, freeing up memory.</li></ul><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=nv>$psr7Response</span><span class=o>-&gt;</span><span class=na>hasHeader</span><span class=p>(</span><span class=s1>'Content-Type'</span><span class=p>))</span> <span class=p>{</span>
    <span class=nv>$psr7Response</span> <span class=o>=</span> <span class=nv>$psr7Response</span><span class=o>-&gt;</span><span class=na>withHeader</span><span class=p>(</span><span class=s1>'Content-Type'</span><span class=p>,</span> <span class=s1>'text/html'</span><span class=p>);</span>
<span class=p>}</span>

<span class=nv>$reactResponse</span><span class=o>-&gt;</span><span class=na>writeHead</span><span class=p>(</span>
    <span class=nv>$psr7Response</span><span class=o>-&gt;</span><span class=na>getStatusCode</span><span class=p>(),</span>
    <span class=nv>$psr7Response</span><span class=o>-&gt;</span><span class=na>getHeaders</span><span class=p>()</span>
<span class=p>);</span>

<span class=nv>$body</span> <span class=o>=</span> <span class=nv>$psr7Response</span><span class=o>-&gt;</span><span class=na>getBody</span><span class=p>();</span>
<span class=nv>$body</span><span class=o>-&gt;</span><span class=na>rewind</span><span class=p>();</span>

<span class=nv>$reactResponse</span><span class=o>-&gt;</span><span class=na>end</span><span class=p>(</span><span class=nv>$body</span><span class=o>-&gt;</span><span class=na>getContents</span><span class=p>());</span>
<span class=nv>$body</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
</code></pre></div></div><p>I also at one point attempted to iterate through the PSR-7 stream, like this:</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>while</span> <span class=p>(</span><span class=o>!</span> <span class=nv>$body</span><span class=o>-&gt;</span><span class=na>eof</span><span class=p>())</span> <span class=p>{</span>
    <span class=nv>$reactResponse</span><span class=o>-&gt;</span><span class=na>write</span><span class=p>(</span><span class=nv>$body</span><span class=o>-&gt;</span><span class=na>read</span><span class=p>(</span><span class=mi>4096</span><span class=p>));</span>
<span class=p>}</span>
<span class=nv>$reactResponse</span><span class=o>-&gt;</span><span class=na>end</span><span class=p>();</span>
</code></pre></div></div><p>Unfortunately, this never worked, and led to connection timeouts. If somebody in the React community wants to edify my as to why (or how I could make it work), I’d appreciate it!</p><h2 id=static-files>Static files</h2><p>When you create an HTTP server, it’s often useful to serve static files: CSS, JS, images, etc. Out of the box, however, React does not do so.</p><p>I tried an approach <a href=https://blog.wyrihaximus.net/2015/04/reactphp-http/ >using React’s filesystem library</a>, but had no luck with it; for some reason, file contents were never returned. As such, I took another approach entirely, and wrote PSR-7 middleware to serve the files, making this the outer layer of my middleware so that it executes earliest, and then delegates to the application middleware when files are not found. I also have the middleware:</p><ul><li>implement a whitelist, to restrict which files may be served</li><li>match directories to index files (e.g., <code class=highlighter-rouge>index.html</code>)</li></ul><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$path</span> <span class=o>=</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>root</span> <span class=o>.</span> <span class=nv>$request</span><span class=o>-&gt;</span><span class=na>getUri</span><span class=p>()</span><span class=o>-&gt;</span><span class=na>getPath</span><span class=p>();</span>
<span class=k>if</span> <span class=p>(</span><span class=nb>is_dir</span><span class=p>(</span><span class=nv>$path</span><span class=p>))</span> <span class=p>{</span>
    <span class=nv>$path</span> <span class=o>=</span> <span class=nb>rtrim</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span> <span class=s1>'/'</span><span class=p>)</span> <span class=o>.</span> <span class=s1>'/index.html'</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=nb>preg_match</span><span class=p>(</span><span class=s1>'#\.(?P&lt;type&gt;[a-z][a-z0-9]{0,3})$#'</span><span class=p>,</span> <span class=nv>$path</span><span class=p>,</span> <span class=nv>$matches</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nv>$next</span><span class=p>(</span><span class=nv>$request</span><span class=p>,</span> <span class=nv>$response</span><span class=p>);</span>
<span class=p>}</span>

<span class=nv>$type</span> <span class=o>=</span> <span class=nv>$matches</span><span class=p>[</span><span class=s1>'type'</span><span class=p>];</span>
<span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=nb>in_array</span><span class=p>(</span><span class=nv>$type</span><span class=p>,</span> <span class=nb>array_keys</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>contentTypeMap</span><span class=p>),</span> <span class=kc>true</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nv>$next</span><span class=p>(</span><span class=nv>$request</span><span class=p>,</span> <span class=nv>$response</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>if</span> <span class=p>(</span><span class=o>!</span> <span class=nb>file_exists</span><span class=p>(</span><span class=nv>$path</span><span class=p>))</span> <span class=p>{</span>
    <span class=k>return</span> <span class=nv>$next</span><span class=p>(</span><span class=nv>$request</span><span class=p>,</span> <span class=nv>$response</span><span class=p>);</span>
<span class=p>}</span>

<span class=k>return</span> <span class=nv>$response</span>
    <span class=o>-&gt;</span><span class=na>withHeader</span><span class=p>(</span><span class=s1>'Content-Type'</span><span class=p>,</span> <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>contentTypeMap</span><span class=p>[</span><span class=nv>$type</span><span class=p>])</span>
    <span class=o>-&gt;</span><span class=na>withBody</span><span class=p>(</span><span class=k>new</span> <span class=nx>Stream</span><span class=p>(</span><span class=nv>$path</span><span class=p>,</span> <span class=s1>'r'</span><span class=p>));</span>
</code></pre></div></div><p>The fun part of this is that, because PSR-7 and React both deal with streams, the approach is incredibly performant, and uses very few resources!</p><h2 id=making-it-reusable>Making it reusable</h2><p>To make this reusable, I created a new library, <a href=https://github.com/phly/react2psr7>phly/react2psr7</a>. This library contains:</p><ul><li><code class=highlighter-rouge>React2Psr7\ReactRequestHandler</code>, which accepts a PSR-7 middleware to its constructor, and then, for each invocation, marshals a PSR-7 request, creates an empty PSR-7 response, dispatches the middleware, and uses the returned response to feed the React response.</li><li><code class=highlighter-rouge>React2Psr7\StaticFiles</code>, which is the PSR-7 middleware for serving static files from the filesystem.</li></ul><p>Install it using:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span>composer require <span class=s2>"react/http:^0.5@dev"</span> phly/react2psr7
</code></pre></div></div><p>(Since this uses the current development series of react/http, you need to install that package manually.)</p><p>A basic server script for an Expressive application then looks like this:</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=cp>&lt;?php</span>
<span class=c1>// server.php
</span><span class=k>use</span> <span class=nx>React\EventLoop\Factory</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>React\Http\Server</span> <span class=k>as</span> <span class=nx>HttpServer</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>React\Socket\Server</span> <span class=k>as</span> <span class=nx>Socket</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>React2Psr7\ReactRequestHandler</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Zend\Expressive\Application</span><span class=p>;</span>

<span class=k>require_once</span> <span class=s1>'vendor/autoload.php'</span><span class=p>;</span>

<span class=nv>$loop</span>      <span class=o>=</span> <span class=nx>Factory</span><span class=o>::</span><span class=na>create</span><span class=p>();</span>
<span class=nv>$socket</span>    <span class=o>=</span> <span class=k>new</span> <span class=nx>Socket</span><span class=p>(</span><span class=nv>$loop</span><span class=p>);</span>
<span class=nv>$http</span>      <span class=o>=</span> <span class=k>new</span> <span class=nx>HttpServer</span><span class=p>(</span><span class=nv>$socket</span><span class=p>);</span>
<span class=nv>$container</span> <span class=o>=</span> <span class=k>require</span> <span class=s1>'config/container.php'</span><span class=p>;</span>

<span class=nv>$http</span><span class=o>-&gt;</span><span class=na>on</span><span class=p>(</span><span class=s1>'request'</span><span class=p>,</span> <span class=k>new</span> <span class=nx>ReactRequestHandler</span><span class=p>(</span><span class=nv>$container</span><span class=o>-&gt;</span><span class=na>get</span><span class=p>(</span><span class=nx>Application</span><span class=o>::</span><span class=na>class</span><span class=p>)));</span>

<span class=c1>// Listen on all ports; omit second argument to restrict to localhost.
</span><span class=nv>$socket</span><span class=o>-&gt;</span><span class=na>listen</span><span class=p>(</span><span class=mi>1337</span><span class=p>,</span> <span class=s1>'0.0.0.0'</span><span class=p>);</span>
<span class=nv>$loop</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>();</span>
</code></pre></div></div><p>For Expressive, I also added configuration for the <code class=highlighter-rouge>StaticFiles</code> middleware to my <code class=highlighter-rouge>config/autoload/middleware-pipeline.global.php</code> file:</p><div class="language-php highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=k>return</span> <span class=p>[</span>
    <span class=s1>'dependencies'</span> <span class=o>=&gt;</span> <span class=p>[</span>
        <span class=s1>'factories'</span> <span class=o>=&gt;</span> <span class=p>[</span>
            <span class=nx>React2Psr7\StaticFiles</span><span class=o>::</span><span class=na>class</span> <span class=o>=&gt;</span> <span class=nx>React2Psr7\StaticFilesFactory</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
            <span class=cm>/* ... */</span>
        <span class=p>],</span>
    <span class=p>],</span>
    <span class=s1>'middleware_pipeline'</span> <span class=o>=&gt;</span> <span class=p>[</span>
        <span class=s1>'static'</span> <span class=o>=&gt;</span> <span class=p>[</span>
            <span class=s1>'middleware'</span> <span class=o>=&gt;</span> <span class=nx>React2Psr7\StaticFiles</span><span class=o>::</span><span class=na>class</span><span class=p>,</span>
            <span class=s1>'priority'</span> <span class=o>=&gt;</span> <span class=mi>100000</span><span class=p>,</span> <span class=c1>// Execute earliest!
</span>        <span class=p>],</span>
        <span class=cm>/* ... */</span>
    <span class=p>],</span>
<span class=p>];</span>
</code></pre></div></div><p>Fire up the server:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span>php server.php
</code></pre></div></div><p>And then start making requests (the following is using <a href=http://httpie.org>HTTPie</a>):</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span>http GET localhost:1337/api/ping
<span class=nv>$ </span>http GET localhost:1337/zf-logo.png
<span class=nv>$ </span>http GET localhost:1337/
</code></pre></div></div><h2 id=next-steps>Next steps</h2><p>I have a couple things on my roadmap still:</p><ul><li>I need to play with file uploads to see how those are handled, and the impact to performance and resource usage. Right now there’s a potential for duplication of the resources, which makes me hesitant to use it in such scenarios.</li><li>I’d like to try and create a variant of the React HTTP server that marshals PSR-7 requests and responses and emits the PSR-7 response directly, instead of requiring casting. This would largely solve the above problems.</li><li>Documentation for the React project. Currently, each subproject has a README file that details the simplest use case, but anything more requires diving through the code. In several cases, I determined that methods are often overloaded to return promises, but how and where that happens is not clear. As such, while the <em>basics</em> of the system are fairly easy to pick up, anything more requires a ton of domain knowledge, which makes in unapproachable. I’d love to help solve that problem through documentation.</li></ul><p>In the meantime, I’m quite happy with my weekend experiment!</p></div></section><div class=row><div class="col-xs-12 col-sm-6"><div class=post-comments><a class="btn btn-primary" href=https://julien.guittard.io/blog/serve-psr-7-middleware-via-react.html#disqus_thread data-disqus-identifier=/blog/serve-psr-7-middleware-via-react.html></a></div></div><div class="col-xs-12 col-sm-6"><div class=social-icons><a href="https://facebook.com/sharer.php?u=https://julien.guittard.io/blog/serve-psr-7-middleware-via-react.html" rel=nofollow target=_blank title="Share on Facebook" class=social-icons__container><span class=zocial-facebook></span></a> <a href="https://twitter.com/intent/tweet?text=Serve PSR-7 Middleware Via React&url=https://julien.guittard.io/blog/serve-psr-7-middleware-via-react.html&via=julienguittard" rel=nofollow target="
            " title="Share on Twitter" class=social-icons__container><span class=zocial-twitter></span></a> <a href="https://plus.google.com/share?url=https://julien.guittard.io/blog/serve-psr-7-middleware-via-react.html" rel=nofollow target=_blank title="Share on Google" class=social-icons__container><span class=zocial-google></span></a></div></div></div><div class=row><div class="col-xs-12 col-sm-6"><div class=post-author id=author-box role=contentinfo itemprop=author itemscope itemtype=http://schema.org/Person><h6>Written By</h6><hr><figure itemprop=image itemscope itemtype=http://schema.org/ImageObject><img src="https://avatars2.githubusercontent.com/u/5320213?s=90&v=4" alt="Author avatar" itemprop=contenturl><meta itemprop=url content="https://avatars2.githubusercontent.com/u/5320213?s=90&v=4"><meta itemprop=width content=90><meta itemprop=height content=90></figure><h5><a href=/about itemprop=url><span itemprop=name>Julien Guittard</span></a></h5><span class=post-author__text></span></div></div><div class="col-xs-12 col-sm-6"><div class=tags><h6>Tags</h6><meta itemprop=keywords content="async, php, programming, psr-7, react"><hr><a href=/blog/tags/async/ class=tags__link rel=tag>async</a> <a href=/blog/tags/php/ class=tags__link rel=tag>php</a> <a href=/blog/tags/programming/ class=tags__link rel=tag>programming</a> <a href=/blog/tags/psr-7/ class=tags__link rel=tag>psr-7</a> <a href=/blog/tags/react/ class=tags__link rel=tag>react</a></div></div></div><div class="disqus-comments push-down-45"><div id=disqus_thread></div><script>var disqus_shortname="julienguittard",disqus_config=function(){this.page.url="https://julien.guittard.io/blog/serve-psr-7-middleware-via-react.html",this.page.identifier="serve-psr-7-middleware-via-react",this.page.title="Serve PSR-7 Middleware Via React"};!function(){var e=document,t=e.createElement("script");t.src="//"+disqus_shortname+".disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div><div class=related-stories><h6>Related Stories</h6><hr></div></div></div></article></div><footer class=footer role=contentinfo><div class=container><div class="col-xs-12 col-md-3"><div class="widget-about push-down-30"><img src=https://julien.guittard.io/images/logo.png alt=Logo width=176 height=70><br><span class=footer__text>Hi, I'm Julien Guittard, welcome to my personal website. I am a web application architect and trainer.</span><br><br><div class="social-icons widget-social-icons"><a href=https://www.twitter.com/julienguittard class=social-icons__container title="Follow me on Twitter"><span class=zocial-twitter></span> </a><a href=https://www.linkedin.com/in/julienguittard class=social-icons__container title="Hire me on LinkedIn"><span class=zocial-linkedin></span> </a><a href=https://github.com/jguittard class=social-icons__container title="Clone me on Github"><span class=zocial-github></span> </a><a href=/feed.xml class=social-icons__container title="Read me through RSS"><span class=zocial-rss></span></a></div></div></div><div class="col-xs-12 col-md-3"><div class="tags widget-tags"><h6>Tags</h6><hr><a href=/blog/tags/:tag/http class=tags__link rel=tag>http</a> <a href=/blog/tags/:tag/middleware class=tags__link rel=tag>middleware</a> <a href=/blog/tags/:tag/php class=tags__link rel=tag>php</a> <a href=/blog/tags/:tag/programming class=tags__link rel=tag>programming</a> <a href=/blog/tags/:tag/psr-7 class=tags__link rel=tag>psr-7</a></div></div><div class="col-xs-12 col-md-3"><div class="widget-navigation push-down-30"><h6>Navigation</h6><hr><ul class=navigation><li><a href=https://julien.guittard.io/ >Home</a></li><li><a href=https://julien.guittard.io/blog/ >Blog</a></li><li><a href=https://julien.guittard.io/about-me/ >About me</a></li><li><a href=https://julien.guittard.io/contact/ >Contact</a></li></ul></div></div><div class="col-xs-12 col-md-3"><div class="widget-contact push-down-30"><h6>Contact</h6><hr></div></div></div></footer><section class=copyrights><div class=container><div class=row><div class="col-xs-12 col-sm-6">Copyright 2009-2018 &copy; by Julien Guittard.</div><div class="col-xs-12 col-sm-6"><div class=copyrights--right>Made with <i class="glyphicon glyphicon-heart"></i> using <a href=https://jekyllrb.com/ target=_blank>Jekyll</a> and <a href=https://pages.github.com target=_blank>Github Pages</a>.</div></div></div></div></section><script src=https://julien.guittard.io/jquery/dist/jquery.js charset=utf-8></script><script src=https://julien.guittard.io/sass-bootstrap/dist/js/bootstrap.js charset=utf-8></script><script src=https://julien.guittard.io/underscore/underscore.js charset=utf-8></script><script src=https://julien.guittard.io/scripts/main.js></script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","","auto"),ga("send","pageview")</script><script id=dsq-count-scr src=//julienguittard.disqus.com/count.js async></script></body></html>