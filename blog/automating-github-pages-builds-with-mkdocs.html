<!DOCTYPE html><html lang=en xml:lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=Content-Type content="text/html; charset=UTF-8"><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=0"><meta name=theme-color content=#70b49c><meta name=msapplication-navbutton-color content=#70b49c><meta name=apple-mobile-web-app-status-bar-style content=black-translucent><meta name=mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-capable content=yes><meta name=application-name content="Julien Guittard"><meta name=apple-mobile-web-app-title content="Julien Guittard"><meta name=msapplication-starturl content=/ ><link rel=canonical itemprop=url href=https://julien.guittard.io/blog/automating-github-pages-builds-with-mkdocs.html><link rel=alternate type=application/rss+xml title=RSS href=/feed.xml><title>Julien Guittard &nbsp;|&nbsp;Automating GitHub Pages Builds with MkDocs</title><meta name=author itemprop=author content="Julien Guittard"><link rel=author href="http://google.com/+JulienGuittardWebpage?rel=author"><meta name=description itemprop=description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta property=og:locale content=en_US><meta property=og:type content=article><meta property=og:title content="Automating GitHub Pages Builds with MkDocs"><meta property=og:url content=https://julien.guittard.io/blog/automating-github-pages-builds-with-mkdocs.html><meta property=og:image content=https://julien.guittard.io/thumbs/ ><meta property=og:site_name content="Julien Guittard"><meta property=article:publisher content=http://www.facebook.com/julien.guittard><meta property=article:author content=https://www.facebook.com/julien.guittard><meta property=article:published_time content=2016-01-29T11:55:00-04:00><meta property=og:description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Automating GitHub Pages Builds with MkDocs"><meta name=twitter:description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta name=twitter:site content=@julienguittard><meta name=twitter:creator content=@julienguittard><meta name=twitter:card content=summary><link rel=manifest href=/manifest.json><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon href=/icons/icon-128.png><link rel=icon href=/icons/icon-192.png><link rel=icon href=/icons/icon-120.png><link rel=icon href=/icons/icon-120.png sizes=120x120><link rel=icon href=/icons/icon-152.png sizes=152x152><link rel=icon href=/icons/icon-167.png sizes=167x167><link rel=icon href=/icons/icon-180.png sizes=180x180><link rel=stylesheet type=text/css href=/styles/main.css><!--[if lt IE 9]>
  	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  	<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]--><script type=text/javascript>WebFontConfig={google:{families:["Open+Sans:300,400,700:latin","Lato:700,900:latin"]}},function(){var t=document.createElement("script");t.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",t.type="text/javascript",t.async="true";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></head><body itemscope itemtype=https://schema.org/WebPage><header class="header push-down-45" role=banner itemscope itemtype=http://schema.org/WPHeader><div class=container><div class="logo pull-left" itemprop=publisher itemscope id=jg-organization itemtype=https://schema.org/Organization><a href=/ rel=home itemprop=url><span itemprop=logo itemscope itemtype=https://schema.org/ImageObject><img itemprop=contenturl src=https://julien.guittard.io/images/logo.png alt=JG width=352 height=140><meta itemprop=width content=352><meta itemprop=height content=140><meta itemprop=url content=https://julien.guittard.io/images/logo.png></span><meta itemprop=name content="Julien Guittard"></a></div><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#top-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button></div><nav class="navbar navbar-default" role=navigation><div class="collapse navbar-collapse" id=top-navbar-collapse><ul class=navigation role=menu itemscope itemtype=http://www.schema.org/SiteNavigationElement><li role=menuitem><a href=https://julien.guittard.io/ itemprop=url><span itemprop=name>Home</span></a></li><li role=menuitem><a href=https://julien.guittard.io/blog/ itemprop=url><span itemprop=name>Blog</span></a></li><li role=menuitem><a href=https://julien.guittard.io/about-me/ itemprop=url><span itemprop=name>About me</span></a></li><li role=menuitem><a href=https://julien.guittard.io/contact/ itemprop=url><span itemprop=name>Contact</span></a></li></ul></div></nav><div class="hidden-xs hidden-sm"><a href=# class="search__container js--toggle-search-mode"><span class="glyphicon glyphicon-search"></span></a><div class=social><a href=# class=social__container><span class="glyphicon glyphicon-heart"></span></a><ul class=social__dropdown><li><a href=https://www.twitter.com/julienguittard target=_blank class=social__container title="Follow me on Twitter"><span class=zocial-twitter></span></a></li><li><a href=https://www.linkedin.com/in/julienguittard target=_blank class=social__container title="Hire me on LinkedIn"><span class=zocial-linkedin></span></a></li><li><a href=https://github.com/jguittard target=_blank class=social__container title="Clone me on Github"><span class=zocial-github></span></a></li><li><a href=/feed.xml target=_blank class=social__container title="Read me through RSS"><span class=zocial-rss></span></a></li></ul></div></div></div></header><div class=search-panel><div class=container><div class=row><div class=col-xs-12><form action=/search itemprop=potentialAction itemscope itemtype=https://schema.org/SearchAction><meta itemprop=target content="https://julien.guittard.io/search?q="><input itemprop=query-input type=search name=q class="search-panel__form js--search-panel-text" placeholder="Begin typing for search"><p class=search-panel__text>Press enter to see results or esc to cancel.</p></form></div></div></div></div><div class=container><article class="boxed push-down-60" itemscope itemtype=http://schema.org/BlogPosting itemref=jg-organization><link itemprop=mainEntityOfPage href=https://julien.guittard.io/blog/automating-github-pages-builds-with-mkdocs.html><header class=meta><div class=row><div class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2"><div class=meta__container--without-image><div class=row><div class="col-xs-12 col-sm-8"><div class=meta__info><span class=meta__author role=contentinfo itemprop=author itemscope itemtype=http://schema.org/Person><figure itemprop=image itemscope itemtype=http://schema.org/ImageObject><img src="https://avatars2.githubusercontent.com/u/5320213?s=90&v=4" alt="Author avatar" width=30 height=30><meta itemprop=width content=30><meta itemprop=height content=30></figure><a href=/about target=_blank rel=author itemprop=url><span itemprop=name>Julien</span> </a>in <a href=/blog/categories/devops/ >DevOps</a> </span><span class=meta__date role=contentinfo><span class="glyphicon glyphicon-calendar"></span> &nbsp; <time itemprop=datePublished datetime=2016-01-29T11:55:00-04:00>January 29, 2016</time><meta itemprop=dateModified content=2016-01-29T11:55:00-04:00></span></div></div><div class="col-xs-12 col-sm-4"><div class=meta__comments><span class="glyphicon glyphicon-comment"></span> &nbsp; <a href=/blog/automating-github-pages-builds-with-mkdocs.html#disqus_thread data-disqus-identifier=/blog/automating-github-pages-builds-with-mkdocs.html>Comments</a></div></div></div></div></div></div></header><div class=row><div class="col-xs-10 col-xs-offset-1 col-md-8 col-md-offset-2 push-down-60"><section class=post-content><h1 itemprop=headline>Automating GitHub Pages Builds with MkDocs</h1><h3 itemprop=description>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor.</h3><div itemprop=articleBody><p>One of the final tasks in prepping for the <a href=/blog/2016-01-28-expressive-stable.html>Expressive 1.0 release</a> was setting up the documentation site. We’d decided to use GitHub Pages for this, and we wanted to automate builds so that as we push to the master branch, documentation is deployed.</p><p>The process turned out both simple and bewilderingly difficult. This post is intended to help others in the same situation.</p><h2 id=requirements>Requirements</h2><p>In looking at the problem, we realized we had a number of requirements we needed to consider for any solution we developed.</p><h3 id=technologies>Technologies</h3><p>First, we chose <a href=http://www.mkdocs.org>MkDocs</a> for our documentation. MkDocs uses plain old Markdown, which we’re already quite comfortable with due to being on GitHub, StackOverflow, Slack, and so many other services that use it. With MkDocs, you create a file, <code class=highlighter-rouge>mkdocs.yml</code>, in which you specify the table of contents, linking titles to the documents themselves. Once you run it, it generates static HTML files.</p><p>MkDocs allows you to specify a template, and ships with several of its own; the most well-known is the one used on <a href=http://rtfd.org>ReadTheDocs</a>. One reason we chose MkDocs is because it has a good-sized ecosystem, which means quite a few themes to choose from; this gave us a tremendous boost in rolling out something that both looked good and was usable.</p><p>This meant, however, that we had the following dependencies in order to build our documentation:</p><ul><li>MkDocs itself.</li><li>One or more python extensions; in particular, we chose an extension that fixes issues with how the default Markdown renderer renders fenced code blocks that are part of bullet points or blockquotes.</li><li>The custom theme we were developing.</li></ul><p>As such, this meant our build automation was going to require grabbing these items, ideally caching them between builds.</p><h3 id=build-only-when-necessary>Build only when necessary</h3><p>The other aspect is that there’s no reason to build the documentation for every build we do on the CI server. We only want to build:</p><ul><li>on the master branch,</li><li>when it’s not a pull request,</li><li>if the build is a success,</li><li>and only once per build.</li></ul><p>On any given build, we’re actually running at least four jobs, one each for PHP 5.5, 5.6, 7, and HHVM. We don’t want to build and deploy the documentation for each!</p><h3 id=reusability>Reusability</h3><p>While we were doing this initially for Expressive, we also want to do the same for each of the ZF components. So any solution we built needed to be reusable with minimum fuss. If we have an update to the theme, we don’t want to have to update each and every one of the component repositories! Similarly, if there are any changes to the deployment script, we don’t want to have to roll it out to all the repositories.</p><h3 id=pushing-to-gh-pages>Pushing to gh-pages</h3><p>Finally, any build automation we did would be required to push to the gh-pages branch of the repository on successful build. This would require having a token or user credentials on the CI server.</p><h2 id=creating-the-automation>Creating the automation</h2><p>With the requirements in place, we could start work on the solution. Since we already use <a href=https://travis-ci.org>Travis-CI</a> for our builds, we decided to re-use it for building documentation. Of course, the challenge then was creating appropriate configuration to meet our requirements.</p><h3 id=github-credentials>GitHub credentials</h3><p>In order to push from Travis, we need to have adequate credentials. There are a couple of ways to do this:</p><ul><li>Use a <a href=https://help.github.com/articles/creating-an-access-token-for-command-line-use/ >personal access token</a>.</li><li>Supply your private SSH key.</li></ul><p>In both cases, you need to add information to your Travis environment. The problem, however, is that if anybody has access to these values, they can essentially commit using your credentials — which you <em>definitely</em> do not want to have happen! As such, you need to encrypt the value so that only Travis knows about it.</p><p>I covered encrypting your SSH key in my blog post <a href=/blog/2015-12-14-secure-phar-automation.html>on secure PHAR automation</a>, and, in that particular case, I had several files needing encryption, which led to a fairly complex setup. If you have no other secrets to encrypt, go with the personal access token. For one, it simplifies security; if you find the token has been compromised, you can simply delete it from GitHub, without needing to go to the extra work of creating a new SSH key and propagating it. It also simplifies setup, as you can encrypt a single value, and simply configure it.</p><p>To encrypt the token, use the <a href=https://github.com/travis-ci/travis.rb#readme>Travis CLI tool</a>, and then paste the value into your <code class=highlighter-rouge>.travis.yml</code>. In the following, I assign it to the env variable <code class=highlighter-rouge>GH_TOKEN</code>, which is a common convention:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span>travis encrypt <span class=nt>-r</span> &lt;org&gt;/&lt;repo&gt; <span class=nv>GH_TOKEN</span><span class=o>=</span>&lt;token value&gt;
</code></pre></div></div><p>Obviously, substitute your organization and repository names, as well as your token. This will output something like this:</p><div class=highlighter-rouge><div class=highlight><pre class=highlight><code>Please add the following to your .travis.yml file:

  secure: "......="

Pro Tip: You can add it automatically by running with --add.
</code></pre></div></div><p>Note: I never use the <code class=highlighter-rouge>--add</code> switch, as the <code class=highlighter-rouge>travis</code> utility changes all the whitespacing in the file.</p><p>Copy and paste the value into the <code class=highlighter-rouge>env.global</code> section of your <code class=highlighter-rouge>.travis.yml</code> (creating it if you haven’t already):</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>env</span><span class=pi>:</span>
  <span class=na>global</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>secure</span><span class=pi>:</span> <span class=s2>"</span><span class=s>..."</span>
</code></pre></div></div><p>Travis will automatically decrypt the value and export it to your environment. In its logs, you’ll see <code class=highlighter-rouge>GH_TOKEN=secure</code>.</p><h3 id=when-to-build>When to build?</h3><p>We know that Travis-CI has a number of events it triggers as part of a typical build workflow:</p><ul><li><code class=highlighter-rouge>before_install</code></li><li><code class=highlighter-rouge>install</code></li><li><code class=highlighter-rouge>script</code></li><li><code class=highlighter-rouge>after_script</code></li><li><code class=highlighter-rouge>deploy</code> (and <code class=highlighter-rouge>before_deploy</code> and <code class=highlighter-rouge>after_deploy</code>)</li></ul><p>The <code class=highlighter-rouge>deploy</code> event may seem like the correct one, but it requires a very specific workflow, which we won’t be using. But it turns out there’s another event you can use: <code class=highlighter-rouge>after_success</code>! It runs after <code class=highlighter-rouge>script</code>, and before either <code class=highlighter-rouge>deploy</code> or <code class=highlighter-rouge>after_script</code> are triggered.</p><p>That said, I discovered something problematic: Travis’ caching happens immediately following <code class=highlighter-rouge>script</code>, and before <code class=highlighter-rouge>after_success</code>, <code class=highlighter-rouge>deploy</code>, or <code class=highlighter-rouge>after_script</code>. This meant that any assets we installed as part of documentation deployment — MkDocs, the theme, etc. — would not be cached.</p><p>So I reached out to Travis’ support team, and they told me about another cool trick: the <code class=highlighter-rouge>$TRAVIS_TEST_RESULT</code> variable indicates the current exit status from the <code class=highlighter-rouge>script</code> section; we could test this on the last line of the <code class=highlighter-rouge>script</code> section to conditionally install assets!</p><p>As a result, we ended up with a line under <code class=highlighter-rouge>script</code> to install the assets, and another under <code class=highlighter-rouge>after_success</code> to perform the actual build. They could likely be combined, but I chose not to: I don’t want the results of building the documentation to result in a failed build. I hope one day that caching will happen at the end of the build instead, so we can put them both under <code class=highlighter-rouge>after_success</code>.</p><h3 id=environment-variables>Environment variables</h3><p>This leads to environment variables. In order to determine if a documentation build is necessary, we can use an environment variable that is only set for the environment in which we want to build. Since most projects I do are PHP, we had to choose which build in the matrix to use. Our projects test on PHP 5.5, 5.6, 7.0, and HHVM. Since most of our users are on PHP 5 versions, we decided to do documentation builds on the latest stable 5 build: 5.6.</p><p>We also only want to build if we’re on the master branch, and <em>not</em> as part of a pull request; the branch reports as master if a pull request was issued against that branch, which is why the criteria is so specific.</p><p>Finally, I know that, eventually, I’ll have MkDocs installed. Due to the fact that we’re using Docker builds on Travis, I also know that this means I’ll be installing MkDocs using <code class=highlighter-rouge>pip install --user</code> versus via apt-get, since we don’t have root access. This means that MkDocs will be in <code class=highlighter-rouge>$HOME/.local/bin</code>, so I’ll need to update my <code class=highlighter-rouge>$PATH</code> for the environment in which I build.</p><p>Fortunately, you can do env variable declarations that are the product of calculations in your <code class=highlighter-rouge>.travis.yml</code>. This meant that I ended up with the following build matrix:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>matrix</span><span class=pi>:</span>
  <span class=na>fast_finish</span><span class=pi>:</span> <span class=no>true</span>
  <span class=na>include</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>php</span><span class=pi>:</span> <span class=s>5.5</span>
      <span class=na>env</span><span class=pi>:</span>
        <span class=pi>-</span> <span class=s>EXECUTE_CS_CHECK=true</span>
    <span class=pi>-</span> <span class=na>php</span><span class=pi>:</span> <span class=s>5.6</span>
      <span class=na>env</span><span class=pi>:</span>
        <span class=pi>-</span> <span class=s>EXECUTE_TEST_COVERALLS=true</span>
        <span class=pi>-</span> <span class=s>DEPLOY_DOCS="$(if [[ $TRAVIS_BRANCH == 'master' &amp;&amp; $TRAVIS_PULL_REQUEST == 'false' ]]; then echo -n 'true' ; else echo -n 'false' ; fi)"</span>
        <span class=pi>-</span> <span class=s>PATH="$HOME/.local/bin:$PATH"</span>
    <span class=pi>-</span> <span class=na>php</span><span class=pi>:</span> <span class=s>7</span>
    <span class=pi>-</span> <span class=na>php</span><span class=pi>:</span> <span class=s>hhvm</span>
  <span class=na>allow_failures</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>php</span><span class=pi>:</span> <span class=s>hhvm</span>
</code></pre></div></div><p>This creates a new <code class=highlighter-rouge>$DEPLOY_DOCS</code> environment variable with values of either “true” or “false”, which I can then test later. My <code class=highlighter-rouge>$PATH</code> is also updated.</p><p>The above are build-specific variables. However, I also needed a few variables that could be accessed by scipts:</p><ul><li>I want to be able to provide the base site URL to my mkdocs configuration. We don’t include this in the <code class=highlighter-rouge>mkdocs.yml</code> by default, so that you can build locally. For our production pages, though, we need it to ensure the search functionality works correctly, as we’ll be in a sub-path.</li><li>In order to commit via git, git requires the user’s name and email. My experience has also been that these need to match the user who generated the personal access token.</li><li>Because we want the functionality re-usable, I’ll also need to provide the location of the git repository.</li></ul><p>As such, I made the following additions to my <code class=highlighter-rouge>env.global</code> section:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>env</span><span class=pi>:</span>
  <span class=na>global</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>SITE_URL</span><span class=pi>:</span> <span class=s>https://organization.github.io/repository</span>
    <span class=pi>-</span> <span class=na>GH_USER_NAME</span><span class=pi>:</span> <span class=s2>"</span><span class=s>My</span><span class=nv> </span><span class=s>Full</span><span class=nv> </span><span class=s>Name"</span>
    <span class=pi>-</span> <span class=na>GH_USER_EMAIL</span><span class=pi>:</span> <span class=s>me@domain.tld</span>
    <span class=pi>-</span> <span class=na>GH_REF</span><span class=pi>:</span> <span class=s>github.com/organization/repository.git</span>
    <span class=pi>-</span> <span class=na>secure</span><span class=pi>:</span> <span class=s2>"</span><span class=s>..."</span>
</code></pre></div></div><p><code class=highlighter-rouge>GH_REF</code> is the reference to the github repository being used. You’ll note the lack of a scheme to the URL; this is because the script for pushing the commits to the gh-pages branch will create the full URL using the <code class=highlighter-rouge>GH_TOKEN</code>:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code>git remote add upstream https://<span class=k>${</span><span class=nv>GH_TOKEN</span><span class=k>}</span>@<span class=k>${</span><span class=nv>GH_REF</span><span class=k>}</span>
</code></pre></div></div><p>Now that the environment is all setup, we can approach installation of the theme, and building the docs.</p><h3 id=how-to-install>How to install?</h3><p>In order to build the docs with our custom theme, we need the custom theme locally. Additionally, we likely want to download the theme only when there are changes; we should cache it between requests. Additionally, if assets are not cached, we should <em>not</em> download them unless the build has been successful.</p><p>This, frankly, was one of the harder parts to figure out, and I ended up needing some pointers from the support team at Travis to figure it out. (Thanks for the great pointers, you fine folks at Travis!)</p><p>As noted earlier, caching occurs immediately following execution of the <code class=highlighter-rouge>script</code> section. This rules out the <code class=highlighter-rouge>after_success</code> script for this task, as any assets downloaded then will never be cached. But how do we know when the build is successful?</p><p>As noted earlier, the environment variable <code class=highlighter-rouge>TRAVIS_TEST_RESULT</code> holds the exit value for the build. If any part of the script returns a non-zero value, then the value will be non-zero from that point forward. As such, if we place a script at the end of the <code class=highlighter-rouge>script</code> section that tests this value, we can conditionally trigger an action!</p><p>I chose to create a script in our theme repository that has all the logic for our documentation toolchain installation. This allows us to modify the installation script as needed, without needing to update the various components that will be adding the automation. The script currently looks something like this:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c>#!/usr/bin/env bash</span>
pip install <span class=nt>--user</span> mkdocs
pip install <span class=nt>--user</span> pymdown-extensions
<span class=k>if</span> <span class=o>[[</span> <span class=o>!</span> <span class=nt>-d</span> zf-mkdoc-theme/theme <span class=o>]]</span><span class=p>;</span><span class=k>then
    </span>mkdir <span class=nt>-p</span> zf-mkdoc-theme <span class=p>;</span>
    curl <span class=nt>-s</span> <span class=nt>-L</span> https://github.com/zendframework/zf-mkdoc-theme/releases/latest | egrep <span class=nt>-o</span> <span class=s1>'/zendframework/zf-mkdoc-theme/archive/[0-9]*\.[0-9]*\.[0-9]*\.tar\.gz'</span> | head <span class=nt>-n1</span> | wget <span class=nt>-O</span> zf-mkdoc-theme.tgz <span class=nt>--base</span><span class=o>=</span>https://github.com/ <span class=nt>-i</span> - <span class=p>;</span>
    <span class=o>(</span>
        <span class=nb>cd </span>zf-mkdoc-theme <span class=p>;</span>
        <span class=nb>tar </span>xzf ../zf-mkdoc-theme.tgz <span class=nt>--strip-components</span><span class=o>=</span>1 <span class=p>;</span>
    <span class=o>)</span><span class=p>;</span>
<span class=k>fi

</span><span class=nb>exit </span>0
</code></pre></div></div><p>The above runs our <code class=highlighter-rouge>pip install</code> commands to install MkDocs and the extensions we use, and, if the theme directory is missing, identifies and downloads the latest tarball of the theme and extracts it.</p><blockquote><p>One gotcha I encountered: When you enable caching of a directory, Travis creates the directory even if no cache entries were found for it; as such, we need to test for a path <em>under</em> the directory.</p></blockquote><p>Now, how do we get the installation script? With the following line in our <code class=highlighter-rouge>script</code> section:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>script</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=s>&lt;build tasks&gt;</span>
  <span class=pi>-</span> <span class=s>if [[ $DEPLOY_DOCS == "true" &amp;&amp; "$TRAVIS_TEST_RESULT" == "0" ]]; then wget -O theme-installer.sh "https://raw.githubusercontent.com/zendframework/zf-mkdoc-theme/master/theme-installer.sh" ; chmod 755 theme-installer.sh ; ./theme-installer.sh ; fi</span>
</code></pre></div></div><p>The above grabs the script and executes it, but only if we’re in the environment designated for documentation deployment, and only if the build has been successful to this point. This should <em>always</em> be the last line of the <code class=highlighter-rouge>script</code> section.</p><h3 id=how-to-build>How to build?</h3><p>Now that we know we have the build tools, what about building the documentation itself?</p><p>For this, I wrote a deployment script, which we include in our theme repository. We include it in the theme for <em>reusability</em> which was one of our requirements. This ensures that as build and deployment change, we don’t need to update all the repositories that are building documentation; we can make the changes in the theme repository, tag a new release, and on the next build, each will pick up the changes.</p><p>The deployment script performs several tasks:</p><ul><li>It creates the build directory, and initializes it as a git repository with the upstream set to the repository’s gh-pages branch, using the <code class=highlighter-rouge>GH_TOKEN</code> and <code class=highlighter-rouge>GH_HREF</code>.</li><li>It sets the git configuration to use the configured GitHub user name and email.</li><li>It runs the build (which is itself another script).</li><li>It adds the changed files, commits them, and pushes them to the remote.</li></ul><p>In the end, the deployment script looks like this:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c>#!/usr/bin/env bash</span>
<span class=nb>set</span> <span class=nt>-o</span> errexit <span class=nt>-o</span> nounset

<span class=nv>SCRIPT_PATH</span><span class=o>=</span><span class=s2>"</span><span class=k>$(</span><span class=nb>cd</span> <span class=s2>"</span><span class=k>$(</span>dirname <span class=s2>"</span><span class=nv>$0</span><span class=s2>"</span><span class=k>)</span><span class=s2>"</span> <span class=o>&amp;&amp;</span> <span class=nb>pwd</span> <span class=nt>-P</span><span class=k>)</span><span class=s2>"</span>

<span class=c># Get curent commit revision</span>
<span class=nv>rev</span><span class=o>=</span><span class=k>$(</span>git rev-parse <span class=nt>--short</span> HEAD<span class=k>)</span>

<span class=c># Initialize gh-pages checkout</span>
mkdir <span class=nt>-p</span> doc/html
<span class=o>(</span>
    <span class=nb>cd </span>doc/html
    git init
    git config user.name <span class=s2>"</span><span class=k>${</span><span class=nv>GH_USER_NAME</span><span class=k>}</span><span class=s2>"</span>
    git config user.email <span class=s2>"</span><span class=k>${</span><span class=nv>GH_USER_EMAIL</span><span class=k>}</span><span class=s2>"</span>
    git remote add upstream <span class=s2>"https://</span><span class=k>${</span><span class=nv>GH_TOKEN</span><span class=k>}</span><span class=s2>@</span><span class=k>${</span><span class=nv>GH_REF</span><span class=k>}</span><span class=s2>"</span>
    git fetch upstream
    git reset upstream/gh-pages
<span class=o>)</span>

<span class=c># Build the documentation</span>
<span class=k>${</span><span class=nv>SCRIPT_PATH</span><span class=k>}</span>/build.sh

<span class=c># Commit and push the documentation to gh-pages</span>
<span class=o>(</span>
    <span class=nb>cd </span>doc/html
    touch <span class=nb>.</span>
    git add <span class=nt>-A</span> <span class=nb>.</span>
    git commit <span class=nt>-m</span> <span class=s2>"Rebuild pages at </span><span class=k>${</span><span class=nv>rev</span><span class=k>}</span><span class=s2>"</span>
    git push <span class=nt>-q</span> upstream HEAD:gh-pages
<span class=o>)</span>
</code></pre></div></div><blockquote><h4 id=notes-on-the-script>Notes on the script</h4><ul><li>We build our documentation in <code class=highlighter-rouge>doc/html/</code>, which is excluded from the repository via <code class=highlighter-rouge>.gitignore</code>, allowing us to safely clone to that location.</li><li><code class=highlighter-rouge>git add -A .</code> will remove any files previously tracked that are now deleted, and add any new paths found. This makes automating far simpler, as we don’t need to worry about additions, removals, or renames.</li></ul><p>Additionally, you’ll note that the <code class=highlighter-rouge>git push</code> command includes the <code class=highlighter-rouge>-q</code> switch. This is <strong>very</strong> important: if you don’t include it, the command output includes the push URL, which includes the GitHub token! Again, you don’t want that value leaked, so take the steps to ensure it isn’t!</p></blockquote><p>The build script performs a few tasks, which might vary based on your own needs:</p><ul><li>It adds some configuration to the <code class=highlighter-rouge>mkdocs.yml</code>, including:<ul><li>Setting the <code class=highlighter-rouge>site_url</code> value, based on our environment variable.</li><li>Adds configuration for several extensions. In particular, we don’t use Pygments (instead, we opt for using <a href=http://prismjs.com>prism.js</a>), and we use pymdownx.superfences, which corrects issues with fenced code blocks that are nested in lists or blockquotes.</li><li>Specifies the <code class=highlighter-rouge>theme_dir</code>.</li></ul></li><li>It runs <code class=highlighter-rouge>mkdocs build --clean</code></li><li>It runs a few utilities we’ve written for doing things like swapping out the landing page, and adding markup to make images responsive.</li></ul><p>Regarding the <code class=highlighter-rouge>mkdocs.yml</code> changes, the reason we don’t include these by default is two-fold:</p><ul><li>It allows developers to run <code class=highlighter-rouge>mkdocs</code> locally without requiring that the theme or extensions be present.</li><li>It allows us to preview documentation on <a href=http://rtfd.org>ReadTheDocs</a>; while the automation we’re setting up largely obviates the need for that service, it’s still useful for previewing documentation targeting the <code class=highlighter-rouge>develop</code> branch.</li></ul><p>The build script looks like this:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c>#!/usr/bin/env bash</span>
<span class=nv>SCRIPT_PATH</span><span class=o>=</span><span class=s2>"</span><span class=k>$(</span><span class=nb>cd</span> <span class=s2>"</span><span class=k>$(</span>dirname <span class=s2>"</span><span class=nv>$0</span><span class=s2>"</span><span class=k>)</span><span class=s2>"</span> <span class=o>&amp;&amp;</span> <span class=nb>pwd</span> <span class=nt>-P</span><span class=k>)</span><span class=s2>"</span>

<span class=c># Update the mkdocs.yml</span>
cp mkdocs.yml mkdocs.yml.orig
<span class=nb>echo</span> <span class=s2>"site_url: </span><span class=k>${</span><span class=nv>SITE_URL</span><span class=k>}</span><span class=s2>"</span>
<span class=nb>echo</span> <span class=s2>"markdown_extensions:"</span> <span class=o>&gt;&gt;</span> mkdocs.yml
<span class=nb>echo</span> <span class=s2>"    - markdown.extensions.codehilite:"</span> <span class=o>&gt;&gt;</span> mkdocs.yml
<span class=nb>echo</span> <span class=s2>"        use_pygments: False"</span> <span class=o>&gt;&gt;</span> mkdocs.yml
<span class=nb>echo</span> <span class=s2>"    - pymdownx.superfences"</span> <span class=o>&gt;&gt;</span> mkdocs.yml
<span class=nb>echo</span> <span class=s2>"theme_dir: zf-mkdoc-theme/theme"</span> <span class=o>&gt;&gt;</span> mkdocs.yml

mkdocs build <span class=nt>--clean</span>
mv mkdocs.yml.orig mkdocs.yml

<span class=c># Make images responsive</span>
<span class=nb>echo</span> <span class=s2>"Making images responsive"</span>
php <span class=k>${</span><span class=nv>SCRIPT_PATH</span><span class=k>}</span>/img_responsive.php

<span class=c># Replace landing page content</span>
<span class=nb>echo</span> <span class=s2>"Replacing landing page content"</span>
php <span class=k>${</span><span class=nv>SCRIPT_PATH</span><span class=k>}</span>/swap_index.php
</code></pre></div></div><p>You could combine the build and deploy scripts if desired. I did not, as it allows me to clone the theme directory into my component checkout and build the documentation as it will appear:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span><span class=nb>echo</span> <span class=s2>"zf-mkdoc-theme/"</span> <span class=o>&gt;&gt;</span> .git/info/exclude
<span class=nv>$ </span>git clone zendframework/zf-mkdoc-theme
<span class=nv>$ </span>./zf-mkdoc-theme/build.sh
<span class=nv>$ </span>php <span class=nt>-S</span> 0:8000 <span class=nt>-t</span> doc/html/
</code></pre></div></div><p>Now that we have the scripts in place in our theme, we need to tell Travis to execute them. We do that in an <code class=highlighter-rouge>after_success</code> script:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>after_success</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=s>if [[ $DEPLOY_DOCS == "true" ]]; then echo "Preparing to build and deploy documentation" ; ./zf-mkdoc-theme/deploy.sh ; echo "Completed deploying documentation" ; fi</span>
</code></pre></div></div><p>The above will only execute if the build is successful, which means we only need to check if we’re in the target environment. We’ll assume that the documentation build tools and theme are present, and simply execute the deployment script.</p><h2 id=caching>Caching</h2><p>One of the requirements is caching, and in the above, we’ve made some decisions about when to execute certain tasks based on the assumption that we’ll be caching. How do we actually do that, though?</p><p>Travis allows caching assets via configuration. You can specify directories or files, with entries being relative to the checkout unless they are fully qualified paths. We want to cache:</p><ul><li>The results of installing MkDocs.</li><li>The theme directory.</li></ul><p>We’ll add the following configuration:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>cache</span><span class=pi>:</span>
  <span class=na>directories</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>$HOME/.local</span>
    <span class=pi>-</span> <span class=s>zf-mkdoc-theme</span>
</code></pre></div></div><blockquote><p>In the ZF components, we also cache the vendor directory and the global Composer cache, which helps speed up builds tremendously.</p></blockquote><p>With that in place, we’ve now met all of our requirements!</p><h2 id=putting-it-all-together>Putting it all together</h2><p>In the end, the result was our new <a href=https://github.com/zendframework/zf-mkdoc-theme>zf-mkdoc-theme repository</a>. It contains:</p><ul><li>The theme installer script invoked within our <code class=highlighter-rouge>script</code> section, <code class=highlighter-rouge>theme-installer.sh</code>.</li><li>The various build scripts and utilities (<code class=highlighter-rouge>deploy.sh</code>, <code class=highlighter-rouge>build.sh</code>, etc.).</li><li>The MkDocs theme (under the <code class=highlighter-rouge>theme/</code> subdirectory).</li></ul><p>We can now consume this from any of our components, by ensuring the following are in our <code class=highlighter-rouge>.travis.yml</code>:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>sudo</span><span class=pi>:</span> <span class=no>false</span>

<span class=na>language</span><span class=pi>:</span> <span class=s>php</span>

<span class=na>cache</span><span class=pi>:</span>
  <span class=na>directories</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=s>$HOME/.local</span>
    <span class=pi>-</span> <span class=s>zf-mkdoc-theme</span>

<span class=na>env</span><span class=pi>:</span>
  <span class=na>global</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>SITE_URL</span><span class=pi>:</span> <span class=s>https://organization.github.io/repository</span>
    <span class=pi>-</span> <span class=na>GH_USER_NAME</span><span class=pi>:</span> <span class=s2>"</span><span class=s>Name</span><span class=nv> </span><span class=s>of</span><span class=nv> </span><span class=s>Committer"</span>
    <span class=pi>-</span> <span class=na>GH_USER_EMAIL</span><span class=pi>:</span> <span class=s>me@domain.tld</span>
    <span class=pi>-</span> <span class=na>GH_REF</span><span class=pi>:</span> <span class=s>github.com/zendframework/zend-expressive.git</span>
    <span class=pi>-</span> <span class=na>secure</span><span class=pi>:</span> <span class=s2>"</span><span class=s>..."</span>

<span class=na>matrix</span><span class=pi>:</span>
  <span class=na>fast_finish</span><span class=pi>:</span> <span class=no>true</span>
  <span class=na>include</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>php</span><span class=pi>:</span> <span class=s>5.6</span>
      <span class=na>env</span><span class=pi>:</span>
        <span class=pi>-</span> <span class=s>EXECUTE_TEST_COVERALLS=true</span>
        <span class=pi>-</span> <span class=s>DEPLOY_DOCS="$(if [[ $TRAVIS_BRANCH == 'master' &amp;&amp; $TRAVIS_PULL_REQUEST == 'false' ]]; then echo -n 'true' ; else echo -n 'false' ; fi)"</span>
        <span class=pi>-</span> <span class=s>PATH="$HOME/.local/bin:$PATH"</span>

<span class=na>script</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=s>build something</span>
  <span class=pi>-</span> <span class=s>if [[ $DEPLOY_DOCS == "true" &amp;&amp; "$TRAVIS_TEST_RESULT" == "0" ]]; then wget -O theme-installer.sh "https://raw.githubusercontent.com/zendframework/zf-mkdoc-theme/master/theme-installer.sh" ; chmod 755 theme-installer.sh ; ./theme-installer.sh ; fi</span>

<span class=na>after_success</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=s>if [[ $DEPLOY_DOCS == "true" ]]; then echo "Preparing to build and deploy documentation" ; ./zf-mkdoc-theme/deploy.sh ; echo "Completed deploying documentation" ; fi</span>
</code></pre></div></div><p>With the above in place, any pushes to the master branch that succeed on the PHP 5.6 job will then result in updating and deploying our documentation!</p><h2 id=final-notes>Final Notes</h2><p>This was a fun experiment, and I’ve been quite happy with <a href=https://zendframework.github.io/zend-expressive/ >the results</a>. I’m also looking forward to deploying this out to other components and libraries I maintain or assist in, as I love the idea of having up-to-date documentation with a style unique to the project.</p><p>The zf-mkdoc-theme referenced throughout this post is on github, and you can use it as a guideline for your ow projects:</p><ul><li><a href=https://github.com/zendframework/zf-mkdoc-theme>https://github.com/zendframework/zf-mkdoc-theme</a></li></ul><p>I hope others are inspired to do the same, and find the tips in this post useful!</p></div></section><div class=row><div class="col-xs-12 col-sm-6"><div class=post-comments><a class="btn btn-primary" href=https://julien.guittard.io/blog/automating-github-pages-builds-with-mkdocs.html#disqus_thread data-disqus-identifier=/blog/automating-github-pages-builds-with-mkdocs.html></a></div></div><div class="col-xs-12 col-sm-6"><div class=social-icons><a href="https://facebook.com/sharer.php?u=https://julien.guittard.io/blog/automating-github-pages-builds-with-mkdocs.html" rel=nofollow target=_blank title="Share on Facebook" class=social-icons__container><span class=zocial-facebook></span></a> <a href="https://twitter.com/intent/tweet?text=Automating GitHub Pages Builds with MkDocs&url=https://julien.guittard.io/blog/automating-github-pages-builds-with-mkdocs.html&via=julienguittard" rel=nofollow target="
            " title="Share on Twitter" class=social-icons__container><span class=zocial-twitter></span></a> <a href="https://plus.google.com/share?url=https://julien.guittard.io/blog/automating-github-pages-builds-with-mkdocs.html" rel=nofollow target=_blank title="Share on Google" class=social-icons__container><span class=zocial-google></span></a></div></div></div><div class=row><div class="col-xs-12 col-sm-6"><div class=post-author id=author-box role=contentinfo itemprop=author itemscope itemtype=http://schema.org/Person><h6>Written By</h6><hr><figure itemprop=image itemscope itemtype=http://schema.org/ImageObject><img src="https://avatars2.githubusercontent.com/u/5320213?s=90&v=4" alt="Author avatar" itemprop=contenturl><meta itemprop=url content="https://avatars2.githubusercontent.com/u/5320213?s=90&v=4"><meta itemprop=width content=90><meta itemprop=height content=90></figure><h5><a href=/about itemprop=url><span itemprop=name>Julien Guittard</span></a></h5><span class=post-author__text></span></div></div><div class="col-xs-12 col-sm-6"><div class=tags><h6>Tags</h6><meta itemprop=keywords content="automation, github, mkdocs, php, programming"><hr><a href=/blog/tags/automation/ class=tags__link rel=tag>automation</a> <a href=/blog/tags/github/ class=tags__link rel=tag>github</a> <a href=/blog/tags/mkdocs/ class=tags__link rel=tag>mkdocs</a> <a href=/blog/tags/php/ class=tags__link rel=tag>php</a> <a href=/blog/tags/programming/ class=tags__link rel=tag>programming</a></div></div></div><div class="disqus-comments push-down-45"><div id=disqus_thread></div><script>var disqus_shortname="julienguittard",disqus_config=function(){this.page.url="https://julien.guittard.io/blog/automating-github-pages-builds-with-mkdocs.html",this.page.identifier="automating-github-pages-builds-with-mkdocs",this.page.title="Automating GitHub Pages Builds with MkDocs"};!function(){var t=document,i=t.createElement("script");i.src="//"+disqus_shortname+".disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(i)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div><div class=related-stories><h6>Related Stories</h6><hr></div></div></div></article></div><footer class=footer role=contentinfo><div class=container><div class="col-xs-12 col-md-3"><div class="widget-about push-down-30"><img src=https://julien.guittard.io/images/logo.png alt=Logo width=176 height=70><br><span class=footer__text>Hi, I'm Julien Guittard, welcome to my personal website. I am a web application architect and trainer.</span><br><br><div class="social-icons widget-social-icons"><a href=https://www.twitter.com/julienguittard class=social-icons__container title="Follow me on Twitter"><span class=zocial-twitter></span> </a><a href=https://www.linkedin.com/in/julienguittard class=social-icons__container title="Hire me on LinkedIn"><span class=zocial-linkedin></span> </a><a href=https://github.com/jguittard class=social-icons__container title="Clone me on Github"><span class=zocial-github></span> </a><a href=/feed.xml class=social-icons__container title="Read me through RSS"><span class=zocial-rss></span></a></div></div></div><div class="col-xs-12 col-md-3"><div class="tags widget-tags"><h6>Tags</h6><hr><a href=/blog/tags/:tag/http class=tags__link rel=tag>http</a> <a href=/blog/tags/:tag/middleware class=tags__link rel=tag>middleware</a> <a href=/blog/tags/:tag/php class=tags__link rel=tag>php</a> <a href=/blog/tags/:tag/programming class=tags__link rel=tag>programming</a> <a href=/blog/tags/:tag/psr-7 class=tags__link rel=tag>psr-7</a></div></div><div class="col-xs-12 col-md-3"><div class="widget-navigation push-down-30"><h6>Navigation</h6><hr><ul class=navigation><li><a href=https://julien.guittard.io/ >Home</a></li><li><a href=https://julien.guittard.io/blog/ >Blog</a></li><li><a href=https://julien.guittard.io/about-me/ >About me</a></li><li><a href=https://julien.guittard.io/contact/ >Contact</a></li></ul></div></div><div class="col-xs-12 col-md-3"><div class="widget-contact push-down-30"><h6>Contact</h6><hr></div></div></div></footer><section class=copyrights><div class=container><div class=row><div class="col-xs-12 col-sm-6">Copyright 2009-2018 &copy; by Julien Guittard.</div><div class="col-xs-12 col-sm-6"><div class=copyrights--right>Made with <i class="glyphicon glyphicon-heart"></i> using <a href=https://jekyllrb.com/ target=_blank>Jekyll</a> and <a href=https://pages.github.com target=_blank>Github Pages</a>.</div></div></div></div></section><script src=https://julien.guittard.io/jquery/dist/jquery.js charset=utf-8></script><script src=https://julien.guittard.io/sass-bootstrap/dist/js/bootstrap.js charset=utf-8></script><script src=https://julien.guittard.io/underscore/underscore.js charset=utf-8></script><script src=https://julien.guittard.io/scripts/main.js></script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","","auto"),ga("send","pageview")</script><script id=dsq-count-scr src=//julienguittard.disqus.com/count.js async></script></body></html>