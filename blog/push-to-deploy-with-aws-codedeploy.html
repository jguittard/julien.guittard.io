<!DOCTYPE html><html lang=en xml:lang=en><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge,chrome=1"><meta name=Content-Type content="text/html; charset=UTF-8"><meta name=viewport content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=0"><meta name=theme-color content=#70b49c><meta name=msapplication-navbutton-color content=#70b49c><meta name=apple-mobile-web-app-status-bar-style content=black-translucent><meta name=mobile-web-app-capable content=yes><meta name=apple-mobile-web-app-capable content=yes><meta name=application-name content="Julien Guittard"><meta name=apple-mobile-web-app-title content="Julien Guittard"><meta name=msapplication-starturl content=/ ><link rel=canonical itemprop=url href=http://julien.guittard.io/blog/push-to-deploy-with-aws-codedeploy.html><link rel=alternate type=application/rss+xml title=RSS href=/feed.xml><title>Julien Guittard &nbsp;|&nbsp;Push-to-Deploy with AWS CodeDeploy</title><meta name=author itemprop=author content="Julien Guittard"><link rel=author href="https://plus.google.com/+MatthewWeierOPhinney?rel=author"><meta name=description itemprop=description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta property=og:locale content=en_US><meta property=og:type content=article><meta property=og:title content="Push-to-Deploy with AWS CodeDeploy"><meta property=og:url content=http://julien.guittard.io/blog/push-to-deploy-with-aws-codedeploy.html><meta property=og:image content=http://julien.guittard.io/thumbs/ ><meta property=og:site_name content="Julien Guittard"><meta property=article:publisher content=http://www.facebook.com/julien.guittard><meta property=article:author content=https://www.facebook.com/julien.guittard><meta property=article:published_time content=2016-06-30T14:10:00-04:00><meta property=og:description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta name=twitter:card content=summary_large_image><meta name=twitter:title content="Push-to-Deploy with AWS CodeDeploy"><meta name=twitter:description content="Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor."><meta name=twitter:site content=@julienguittard><meta name=twitter:creator content=@julienguittard><meta name=twitter:card content=summary><link rel=manifest href=/manifest.json><link rel=icon type=image/x-icon href=/favicon.ico><link rel=icon href=/icons/icon-128.png><link rel=icon href=/icons/icon-192.png><link rel=icon href=/icons/icon-120.png><link rel=icon href=/icons/icon-120.png sizes=120x120><link rel=icon href=/icons/icon-152.png sizes=152x152><link rel=icon href=/icons/icon-167.png sizes=167x167><link rel=icon href=/icons/icon-180.png sizes=180x180><link rel=stylesheet type=text/css href=/styles/main.css><!--[if lt IE 9]>
  	<script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
  	<script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]--><script type=text/javascript>WebFontConfig={google:{families:["Open+Sans:300,400,700:latin","Lato:700,900:latin"]}},function(){var t=document.createElement("script");t.src=("https:"==document.location.protocol?"https":"http")+"://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js",t.type="text/javascript",t.async="true";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script></head><body itemscope itemtype=https://schema.org/WebPage><header class="header push-down-45" role=banner itemscope itemtype=http://schema.org/WPHeader><div class=container><div class="logo pull-left" itemprop=publisher itemscope id=jg-organization itemtype=https://schema.org/Organization><a href=/ rel=home itemprop=url><span itemprop=logo itemscope itemtype=https://schema.org/ImageObject><img itemprop=contenturl src=http://julien.guittard.io/images/logo.png alt=JG width=352 height=140><meta itemprop=width content=352><meta itemprop=height content=140><meta itemprop=url content=http://julien.guittard.io/images/logo.png></span><meta itemprop=name content="Julien Guittard"></a></div><div class=navbar-header><button type=button class=navbar-toggle data-toggle=collapse data-target=#top-navbar-collapse><span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span></button></div><nav class="navbar navbar-default" role=navigation><div class="collapse navbar-collapse" id=top-navbar-collapse><ul class=navigation role=menu itemscope itemtype=http://www.schema.org/SiteNavigationElement><li role=menuitem><a href=http://julien.guittard.io/ itemprop=url><span itemprop=name>Home</span></a></li><li role=menuitem><a href=http://julien.guittard.io/blog/ itemprop=url><span itemprop=name>Blog</span></a></li><li role=menuitem><a href=http://julien.guittard.io/about-me/ itemprop=url><span itemprop=name>About me</span></a></li><li role=menuitem><a href=http://julien.guittard.io/contact/ itemprop=url><span itemprop=name>Contact</span></a></li></ul></div></nav><div class="hidden-xs hidden-sm"><a href=# class="search__container js--toggle-search-mode"><span class="glyphicon glyphicon-search"></span></a><div class=social><a href=# class=social__container><span class="glyphicon glyphicon-heart"></span></a><ul class=social__dropdown><li><a href=https://www.twitter.com/julienguittard target=_blank class=social__container title="Follow me on Twitter"><span class=zocial-twitter></span></a></li><li><a href=https://www.linkedin.com/in/julienguittard target=_blank class=social__container title="Hire me on LinkedIn"><span class=zocial-linkedin></span></a></li><li><a href=https://github.com/jguittard target=_blank class=social__container title="Clone me on Github"><span class=zocial-github></span></a></li><li><a href=/feed.xml target=_blank class=social__container title="Read me through RSS"><span class=zocial-rss></span></a></li></ul></div></div></div></header><div class=search-panel><div class=container><div class=row><div class=col-xs-12><form action=/search itemprop=potentialAction itemscope itemtype=https://schema.org/SearchAction><meta itemprop=target content="http://julien.guittard.io/search?q="><input itemprop=query-input type=search name=q class="search-panel__form js--search-panel-text" placeholder="Begin typing for search"><p class=search-panel__text>Press enter to see results or esc to cancel.</p></form></div></div></div></div><div class=container><article class="boxed push-down-60" itemscope itemtype=http://schema.org/BlogPosting itemref=jg-organization><link itemprop=mainEntityOfPage href=http://julien.guittard.io/blog/push-to-deploy-with-aws-codedeploy.html><header class=meta><div class=row><div class="col-xs-12 col-sm-10 col-sm-offset-1 col-md-8 col-md-offset-2"><div class=meta__container--without-image><div class=row><div class="col-xs-12 col-sm-8"><div class=meta__info><span class=meta__author role=contentinfo itemprop=author itemscope itemtype=http://schema.org/Person><figure itemprop=image itemscope itemtype=http://schema.org/ImageObject><img src="https://avatars1.githubusercontent.com/u/25943?s=90&v=4" alt="Author avatar" width=30 height=30><meta itemprop=width content=30><meta itemprop=height content=30></figure><a href=https://mwop.net target=_blank rel=author itemprop=url><span itemprop=name>Matthew</span> </a>in <a href=/blog/categories/devops/ >DevOps</a> </span><span class=meta__date role=contentinfo><span class="glyphicon glyphicon-calendar"></span> &nbsp; <time itemprop=datePublished datetime=2016-06-30T14:10:00-04:00>June 30, 2016</time><meta itemprop=dateModified content=2016-06-30T14:10:00-04:00></span></div></div><div class="col-xs-12 col-sm-4"><div class=meta__comments><span class="glyphicon glyphicon-comment"></span> &nbsp; <a href=/blog/push-to-deploy-with-aws-codedeploy.html#disqus_thread data-disqus-identifier=/blog/push-to-deploy-with-aws-codedeploy.html>Comments</a></div></div></div></div></div></div></header><div class=row><div class="col-xs-10 col-xs-offset-1 col-md-8 col-md-offset-2 push-down-60"><section class=post-content><h1 itemprop=headline>Push-to-Deploy with AWS CodeDeploy</h1><h3 itemprop=description>Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor.</h3><div itemprop=articleBody><p><a href=https://aws.amazon.com/codedeploy/ >AWS CodeDeploy</a> is a tool for automating application deployments to EC2 instances and clusters. It can pull application archives from either S3 or GitHub, and then allows you to specify how to install, configure, and run the application via a configuration specification and optionally hook scripts. When setup correctly, it can provide a powerful way to automate your deployments.</p><p>I started looking into it because I wanted to try out my site on PHP 7, and do a few new things with nginx that I wasn’t doing before. Additionally, I’ve accidently forgotten to deploy a few times in the past year after writing a blog post, and I wanted to see if I solve that situation; I’d really enjoyed the “push-to-deploy” paradigm of OpenShift and EngineYard in the past, and wanted to see if I could recreate it.</p><p><a href=http://www.zimuel.it>Enrico</a> first pointed me to the service, and I was later <a href=https://docs.google.com/presentation/d/19r3BCzBmFViJP3YHisn4miJBz2Oq0EH4bbpVDhjWZXQ/edit>inspired by a slide deck by Ric Harvey</a>. The process wasn’t easy, due to a number of things that are not documented or not fully documented in the AWS CodeDeploy documentation, but in the end, I was able to accomplish exactly that: push-to-deploy. This post details what I found, some recommendations on how to create your deployments, and ways to avoid some of the pitfalls I fell into.</p><h2 id=preparing-for-codedeploy-on-aws>Preparing for CodeDeploy on AWS</h2><p>The first thing you need to do is setup a whole slew of profiles, roles, and policies on AWS. The <a href=http://docs.aws.amazon.com/codedeploy/latest/userguide/getting-started-setup.html>AWS CodeDeploy Getting Started guide</a> walks you through the various details of that. While it’s not trivial or easy, I was able to get everything ready without any real stumbling blocks.</p><h2 id=create-an-ec2-instance>Create an EC2 instance</h2><p>Once you’ve setup your IAM (Identity and Access Management) profiles, roles, and policies, you can start enabling CodeDeploy on your EC2 instances. While you can assign an IAM policy to an existing EC2 instance, I recommend using a new instance, to ensure that you can troubleshoot and debug without affecting a running application.</p><p>I went and selected an Ubuntu 16.04 AMI (specifically, ami-32b6515f), as I want to use the latest LTS, and I’m familiar with both Ubuntu and Debian systems. (This turned out to pose a few issues, which I’ll detail later.)</p><p>When I created the instance, I tied it to the IAM policy I created for CodeDeploy, ensuring I’ll be able to use it with that service.</p><h2 id=setting-up-the-ec2-instance>Setting up the EC2 instance</h2><p>If you don’t install the official Amazon Linux AMI, you won’t have the various tools in place needed to run the CodeDeploy agent. Among other things:</p><ul><li>The www-data user is setup such that it cannot use a shell, which means it cannot run scripts — which poses a problem for running deployment scripts or cronjobs as the user.</li><li>You need to install the CodeDeploy agent on the instance, and it may need some dependencies installed depending on the AMI you use.</li></ul><h3 id=www-data>www-data</h3><p>The www-data user exists by default. However, it has the login shell set to <code class=highlighter-rouge>/usr/sbin/nologin</code>. This means that if you specify:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>runas</span><span class=pi>:</span> <span class=s>www-data</span>
</code></pre></div></div><p>in one of your <code class=highlighter-rouge>appspec.yml</code> hooks, it will fail; this also affects execution of crontab entries. The solution is to update the user to have a real login shell. Run:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span><span class=nb>sudo </span>vipw
</code></pre></div></div><p><code class=highlighter-rouge>vipw</code> is a safer way to edit the <code class=highlighter-rouge>/etc/passwd</code> file, and will prompt you for an editor to use before opening it. Find the entry for <code class=highlighter-rouge>www-data</code>, change the shell to <code class=highlighter-rouge>/bin/bash</code>, save, and exit.</p><h3 id=ruby-20>Ruby 2.0</h3><p>In order to install the code deploy agent on the server, you need to have ruby 2.0 installed; the installer for the agent will not work with any other version at this time.</p><p>If you’re on Ubuntu 14.04, or if you’re on the official Amazon Linux AMI, it’s already installed, or can be installed from existing package repositories:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c># On Ubuntu 14.04:</span>
<span class=nv>$ </span><span class=nb>sudo </span>apt-get install ruby2.0
<span class=c># On Amazon Linux or Fedora:</span>
<span class=nv>$ </span><span class=nb>sudo </span>yum install ruby2.0
</code></pre></div></div><p>If, like me, you decide to use Ubuntu 16.04 (xenial), that version is unavailable (the lowest version available is 2.3), and even some well-known package repositories do not have xenial packages available (if they ever will).</p><p>So, I had to create a package, which involves downloading a 2.0 release, using a utility to create a debian package out of it, and then installing it.</p><p>To do that, I did the following:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span><span class=nb>sudo </span>apt-get install checkinstall build-essential zlib1g-dev libssl-dev libreadline6-dev libyaml-dev
<span class=nv>$ </span>wget http://cache.ruby-lang.org/pub/ruby/2.0/ruby-2.0.0-p481.tar.gz
<span class=nv>$ </span><span class=nb>tar </span>xzf ruby-2.0.0-p481.tar.gz
<span class=nv>$ </span><span class=nb>cd </span>ruby-2.0.0-p481
<span class=nv>$ </span><span class=nb>sudo </span>checkinstall <span class=nb>.</span>
</code></pre></div></div><p>When <code class=highlighter-rouge>checkinstall</code> runs, it will prompt you for a few things:</p><div class="language-text highlighter-rouge"><div class=highlight><pre class=highlight><code>The package documentation directory ./doc-pak does not exist.
Should I create a default set of package docs? [y]:
</code></pre></div></div><p>Answer “y”.</p><p>It then asks for a description; I used “Ruby 2.0 interpreter”.</p><p>At this point, it shows you what values the package will be built with. Time to change a few.</p><ul><li>Change the Name (option 2) to “ruby2.0”</li><li>Change the Version (option 3) to “2.0.0-p481”</li><li>Change the Requires list (option 10) to read: build-essential,zlib1g-dev,libssl-dev,libreadline6-dev,libyaml-dev</li><li>Change the Provides list (option 11) to read: ruby-interpreter,ruby-interpreter:any,ruby-interpreter:i386,ruby2.0:any</li></ul><p>Once done, hit ENTER.</p><p>This builds the package in the current directory as <code class=highlighter-rouge>ruby2.0_2.0.0-p481-1_amd64.deb</code>, which you can then install with <code class=highlighter-rouge>dpkg -i</code>, and later remove with <code class=highlighter-rouge>dpkg -r ruby2.0</code>.</p><blockquote><p>The package metadata values are important. Without them, the agent may or may not be able to identify that a usable ruby version is installed on the system.</p></blockquote><h3 id=codedeploy-agent>CodeDeploy Agent</h3><p>To install the code deploy agent, you need to know what region you’re in. From there, you do the following:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span>mkdir code-deploy-agent
<span class=nv>$ </span><span class=nb>cd </span>code-deploy-agent
<span class=nv>$ </span>wget https://aws-codedeploy-<span class=o>{</span>region name<span class=o>}</span>.s3.amazonaws.com/latest/install
<span class=nv>$ </span>chmod +x ./install
<span class=nv>$ </span><span class=nb>sudo</span> ./install auto
</code></pre></div></div><p>I have my EC2 instance launched in us-east-1, so the above url became <code class=highlighter-rouge>https://aws-codedeploy-us-east-1.s3.amazonaws.com/latest/install</code>. (See the <a href=http://docs.aws.amazon.com/codedeploy/latest/userguide/how-to-run-agent-install.html>documentation on installing the agent</a> for valid S3 bucket values for the installer, as not all regions are represented.)</p><p>If you have installed the dependencies as listed above, all should go well. From there, check to see if it’s running:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span><span class=nb>sudo </span>service codedeploy-agent status
</code></pre></div></div><p>If it’s not running, start it:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span><span class=nb>sudo </span>service codedeploy-agent start
</code></pre></div></div><h2 id=creating-your-deployment>Creating your deployment</h2><p>I found that, in the end, PHP application deployment was quite easy with CodeDeploy, but that due to oddities in the <code class=highlighter-rouge>appspec.yml</code> rules, as well as in where and how event hooks scripts are executed, the documentation often failed me. As such, this is probably the most important section of this narrative.</p><p>A basic <code class=highlighter-rouge>appspec.yml</code> has the following structure:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>version</span><span class=pi>:</span> <span class=s>0.0</span>
<span class=na>os</span><span class=pi>:</span> <span class=s>linux</span>
<span class=na>files</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>source</span><span class=pi>:</span> <span class=s>/</span>
    <span class=na>destination</span><span class=pi>:</span> <span class=s>/var/www/example.com</span>
<span class=na>permissions</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>object</span><span class=pi>:</span> <span class=s>/var/www/example.com</span>
    <span class=na>pattern</span><span class=pi>:</span> <span class=s2>"</span><span class=s>**"</span>
    <span class=na>owner</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=na>group</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=na>type</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>directory</span>
      <span class=pi>-</span> <span class=s>file</span>
<span class=na>hooks</span><span class=pi>:</span>
  <span class=na>ApplicationStop</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/application-stop.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
  <span class=na>BeforeInstall</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/before-install.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>300</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
  <span class=na>AfterInstall</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/after-install-www-data.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>300</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/after-install-root.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
  <span class=na>ApplicationStart</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/application-start.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
</code></pre></div></div><p>Let’s talk about each of the sections.</p><h3 id=files>Files</h3><p><code class=highlighter-rouge>files</code> allows you to specify which files from your archive should be installed, and their destination on the filesystem. Each entry requires a <code class=highlighter-rouge>source</code>, which will be a path relative to the archive, and a <code class=highlighter-rouge>destination</code>, which will be its destination on the server.</p><p>If you specify <code class=highlighter-rouge>/</code> (or <code class=highlighter-rouge>\\</code> for Windows instances), CodeDeploy will copy the entire archive. I’ve found this is typically easiest, as the <code class=highlighter-rouge>appspec.yml</code> specification <em>does not provide wildcard functionality</em>, nor any whitelist/blacklist functionality. Yes, you can specify directories or files, but once you go that route, if you have more than a handful, the specification gets unwieldy.</p><blockquote><p>One tip I read early on was to ship the deployable code within a subdirectory of the archive. This is similar to how Zend Server’s ZPK format expects things as well, but it’s pretty much counter to every PHP framework skeleton or application I’ve used or seen.</p></blockquote><p>One thing to know: this does not work like Unix <code class=highlighter-rouge>cp</code> or <code class=highlighter-rouge>mv</code>. With those utilities, if the source is a file and you specify a destination path that does not exist, they will create it as a file. However, CodeDeploy does not. As an example, consider the following:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>files</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>source</span><span class=pi>:</span> <span class=s>.aws/crontab</span>
    <span class=na>destination</span><span class=pi>:</span> <span class=s>/var/spool/cron/crontabs/www-data</span>
</code></pre></div></div><p>Since <code class=highlighter-rouge>/var/spool/cron/crontabs</code> is a directory, if I were using <code class=highlighter-rouge>cp</code> or <code class=highlighter-rouge>mv</code>, I’d expect this operation to create the file <code class=highlighter-rouge>/var/spool/cron/crontabs/www-data</code>. Instead, because the source name and destination name do not match, CodeDeploy creates that as a <em>directory</em>, and then copies the file <code class=highlighter-rouge>crontab</code> beneath it, giving us the file <code class=highlighter-rouge>/var/spool/cron/crontabs/www-data/crontab</code>. Which is utterly unusable. (There are ways around it via hook scripts, which I’ll detail later.)</p><p>Another thing to keep in mind: when providing a source <em>directory</em>, CodeDeploy copies all files under it, recursively, to the destination. If the destination does not include the source directory name, you’ll be in for a surprise:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>files</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>source</span><span class=pi>:</span> <span class=s>bin</span>
    <span class=na>destination</span><span class=pi>:</span> <span class=s>/var/www/example.com</span>
</code></pre></div></div><p>will copy all the files under <code class=highlighter-rouge>bin/</code> to the directory <code class=highlighter-rouge>/var/www/example.com</code>. It <em>will not</em> create a <code class=highlighter-rouge>bin/</code> directory under that path! As such, you likely want to use:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>files</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>source</span><span class=pi>:</span> <span class=s>bin</span>
    <span class=na>destination</span><span class=pi>:</span> <span class=s>/var/www/example.com/bin</span>
</code></pre></div></div><p>For these reasons, I found it was far easier to just copy the entire archive.</p><h3 id=permissions>Permissions</h3><p>The <code class=highlighter-rouge>permissions</code> section allows you to specify permissions for individual files or trees on the server. These are applied during the Install event, after all files have been deployed to their location.</p><p>The format is:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>permissions</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>object</span><span class=pi>:</span> <span class=s>/var/www/example.com</span>
    <span class=na>pattern</span><span class=pi>:</span> <span class=s2>"</span><span class=s>**"</span>
    <span class=na>owner</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=na>group</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=na>mode</span><span class=pi>:</span> <span class=s>4755</span>
    <span class=na>type</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>directory</span>
      <span class=pi>-</span> <span class=s>file</span>
</code></pre></div></div><p>You can specify individual files or directories for the <code class=highlighter-rouge>object</code>. directories require a <code class=highlighter-rouge>pattern</code> following them, which allows you to provide a POSIX glob for specifying files and directories to which to apply the permissions; <code class=highlighter-rouge>**</code> indicates it should match everything under the tree.</p><p>Additionally, the <code class=highlighter-rouge>type</code> parameter allows you to specify whether the permissions apply to specifically directories or files; you can specify both at the same time if desired.</p><p>The owner, group, and mode arguments are just as you would use for either <code class=highlighter-rouge>chown</code>, <code class=highlighter-rouge>chgrp</code>, or <code class=highlighter-rouge>chmod</code>.</p><p>The above will likely work for most cases. I broke that into two separate statements, one for applying to directories, another for files:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>permissions</span><span class=pi>:</span>
  <span class=pi>-</span> <span class=na>object</span><span class=pi>:</span> <span class=s>/var/www/example.com</span>
    <span class=na>pattern</span><span class=pi>:</span> <span class=s2>"</span><span class=s>**"</span>
    <span class=na>owner</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=na>group</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=na>mode</span><span class=pi>:</span> <span class=s>4750</span>
    <span class=na>type</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>directory</span>
  <span class=pi>-</span> <span class=na>object</span><span class=pi>:</span> <span class=s>/var/www/example.com</span>
    <span class=na>pattern</span><span class=pi>:</span> <span class=s2>"</span><span class=s>**"</span>
    <span class=na>owner</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=na>group</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=na>mode</span><span class=pi>:</span> <span class=s>640</span>
    <span class=na>type</span><span class=pi>:</span>
      <span class=pi>-</span> <span class=s>file</span>
</code></pre></div></div><p>There’s a fair amount more you can do; read the <a href=http://docs.aws.amazon.com/codedeploy/latest/userguide/app-spec-ref-permissions.html>appspec.yml permissions documentation</a> for more details.</p><h3 id=hooks>Hooks</h3><p>Hooks allow you to specify scripts to run during each of the CodeDeploy events. There are five events you can listen to:</p><ul><li>ApplicationStop, which occurs at the start of a deployment operation.</li><li>BeforeInstall, which occurs before any <code class=highlighter-rouge>files</code> specified in the <code class=highlighter-rouge>appspec.yml</code> are deployed to their destinations.</li><li>AfterInstall, which occurs after files have been deployed.</li><li>ApplicationStart, which happens after installation is complete</li><li>ValidateService, which happens after the application has been started.</li></ul><p>There are actually a few other events, but only the above can trigger hook scripts.</p><p>As noted in the sample <code class=highlighter-rouge>appspec.yml</code>, the various hook sections have the following format:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>hooks</span><span class=pi>:</span>
  <span class=s>&lt;event name&gt;</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>&lt;path to script&gt;</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>&lt;timeout in seconds&gt;</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>&lt;user to run script as&gt;</span>
</code></pre></div></div><p>The only required element is the <code class=highlighter-rouge>location</code> field, which is the script to execute. The <code class=highlighter-rouge>timeout</code> can be used to help ensure that scripts that take too long to execute fail the deployment, allowing you to return to the previous deployment. The <code class=highlighter-rouge>runas</code> is used to specify a user to execute the script under, and defualts to root; I like to specify it explicitly, and some scripts may need to run under different users (in particular, the www-data user).</p><p>Now come the various caveats and recommendations.</p><p>First things first: I put all the various files related to deployment on AWS in a dedicated directory, <code class=highlighter-rouge>.aws/</code>. This allows me to have it all in one place, and segregate it from the rest of my application.</p><p>Second: I strongly recommend creating a script named after the event in which it executes; e.g., <code class=highlighter-rouge>after-install.sh</code>. This makes identifing which script to edit and debug far simpler. If the script needs to be run as a specific user, I include that in the script name as well: <code class=highlighter-rouge>after-install-www-data.sh</code>.</p><p>Third, the “deployment directory” is not the same as the “installation directory”. The <em>deployment directory</em> is where CodeDeploy downloads your code (whether from GitHub or S3). During the Install event, it <em>copies</em> code from that directory into the final destination (per your <code class=highlighter-rouge>appspec.yml</code> “Files” rules). However, Install <em>will only copy directories that were part of the original archive</em>. That means any files you generate <em>will not be part of the installation directory</em>.</p><p>Fourth, hook script <code class=highlighter-rouge>Location</code> values <em>are always relative to the deployment directory</em>. Not the installation directory. In fact, even <em>fully qualified paths</em> are interpreted as if they were relative to the deployment directory, which means system tools cannot be called directly! As such, you’ll need to make those calls to system tools <em>within a hook script</em>.</p><h4 id=example>Example</h4><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>hooks</span><span class=pi>:</span>
  <span class=na>ApplicationStop</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/application-stop.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
  <span class=na>BeforeInstall</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/before-install.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
  <span class=na>AfterInstall</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/after-install-www-data.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>300</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>www-data</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/after-install-root.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
  <span class=na>ApplicationStart</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>.aws/application-start.sh</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
</code></pre></div></div><h4 id=system-dependencies>System dependencies</h4><p>One cool thing about CodeDeploy is that, other than the requirements to allow the CodeDeploy agent to run and ensuring www-data has a login shell, you can assume that deployment will take care of the everything else for you, much as you would when using Ansible, Puppet, Chef, or Docker.</p><p>The idea is this: during the BeforeInstall event, you will check for and install system dependencies, create directories and configuration, etc.</p><p>One nice aspect about this approach is that if your system requirements change — for example, if you decide to switch between grunt and gulp for preparing your frontend assets — you can alter your hook script to add the new requirement, and it will be installed on the next deployment.</p><p>I wrote one script to handle all of this for my site:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c>#!/bin/bash</span>
<span class=c>#######################################################################</span>
<span class=c># System dependencies</span>
<span class=c>#######################################################################</span>

<span class=c># Install needed dependencies</span>
apt-get update
apt-get install <span class=nt>-y</span> nginx php7.0 php7.0-bcmath php7.0-bz2 php7.0-cli php7.0-ctype php7.0-curl php7.0-dom php7.0-fileinfo php7.0-fpm php7.0-gd php7.0-iconv php7.0-intl php7.0-json php7.0-mbstring php7.0-pdo php7.0-pdo-sqlite php7.0-phar php7.0-readline php7.0-simplexml php7.0-sockets php7.0-sqlite3 php7.0-tidy php7.0-tokenizer php7.0-xml php7.0-xsl php7.0-xmlreader php7.0-xmlwriter php7.0-zip npm python3-pip

<span class=c># aws cli</span>
pip3 install awscli

<span class=c># Get Composer, and install to /usr/local/bin</span>
<span class=k>if</span> <span class=o>[</span> <span class=o>!</span> <span class=nt>-f</span> <span class=s2>"/usr/local/bin/composer"</span> <span class=o>]</span><span class=p>;</span><span class=k>then
    </span>php <span class=nt>-r</span> <span class=s2>"copy('https://getcomposer.org/installer', 'composer-setup.php');"</span>
    php <span class=nt>-r</span> <span class=s2>"if (hash_file('SHA384', 'composer-setup.php') === 'e115a8dc7871f15d853148a7fbac7da27d6c0030b848d9b3dc09e2a0388afed865e6a3d6b3c0fad45c48e2b5fc1196ae') { echo 'Installer verified'; } else { echo 'Installer corrupt'; unlink('composer-setup.php'); } echo PHP_EOL;"</span>
    php composer-setup.php <span class=nt>--install-dir</span><span class=o>=</span>/usr/local/bin <span class=nt>--filename</span><span class=o>=</span>composer
    php <span class=nt>-r</span> <span class=s2>"unlink('composer-setup.php');"</span>
<span class=k>else</span>
    /usr/local/bin/composer self-update <span class=nt>--stable</span> <span class=nt>--no-ansi</span> <span class=nt>--no-interaction</span>
<span class=k>fi</span>

<span class=c># Create a COMPOSER_HOME directory for the application</span>
<span class=k>if</span> <span class=o>[</span> <span class=o>!</span> <span class=nt>-d</span> <span class=s2>"/var/cache/composer"</span> <span class=o>]</span><span class=p>;</span><span class=k>then
    </span>mkdir <span class=nt>-p</span> /var/cache/composer
    chown www-data.www-data /var/cache/composer
<span class=k>fi</span>

<span class=c># Get private configuration</span>
<span class=k>if</span> <span class=o>[</span> <span class=o>!</span> <span class=nt>-d</span> <span class=s2>"/var/www/config"</span> <span class=o>]</span><span class=p>;</span><span class=k>then
    </span>mkdir <span class=nt>-p</span> /var/www/config
<span class=k>fi</span>
<span class=o>(</span><span class=nb>cd</span> /var/www/config <span class=o>&amp;&amp;</span> aws s3 sync s3://config.example.com .<span class=o>)</span>

<span class=c># Make a log directory for php-fpm</span>
<span class=k>if</span> <span class=o>[</span> <span class=o>!</span> <span class=nt>-d</span> <span class=s2>"/var/log/php"</span> <span class=o>]</span><span class=p>;</span><span class=k>then
    </span>mkdir <span class=nt>-p</span> /var/log/php
<span class=k>fi
</span>chown <span class=nt>-R</span> www-data.www-data /var/log/php
chmod <span class=nt>-R</span> ug+rwX /var/log/php

<span class=c># Install grunt globally</span>
npm install <span class=nt>-g</span> grunt-cli

<span class=c># Ensure we can run npm as www-data</span>
<span class=k>if</span> <span class=o>[</span> <span class=o>!</span> <span class=nt>-d</span> <span class=s2>"/var/www/.npm"</span> <span class=o>]</span><span class=p>;</span><span class=k>then
    </span>mkdir <span class=nt>-p</span> /var/www/.npm
    chown www-data.www-data /var/www/.npm
    chmod o-X /var/www/.npm
    chmod ug+rwX /var/www/.npm
<span class=k>fi</span>
</code></pre></div></div><p>As you can see, I do some <em>conditional</em> installation as well; if certain files or directories exist, I can skip over them or treat them differently. In the case of running <code class=highlighter-rouge>apt-get</code>, <code class=highlighter-rouge>pip3</code>, or <code class=highlighter-rouge>npm</code>, I know that these applications will check to see if the latest version is installed before attempting to do anything, making these very fast operations most of the time.</p><blockquote><p>Some notes on a few items in there:</p><ul><li>I created a <code class=highlighter-rouge>COMPOSER_HOME</code> directory as composer requires a place to cache the results of pulling information from Packagist, as well as packages it has downloaded. Since the www-data user doesn’t have rights to create files or directories under <code class=highlighter-rouge>/var/www</code>, we need to create a directory for it to use.</li><li>Similarly, npm caches to <code class=highlighter-rouge>$HOME/.npm</code>. If there’s a way to specify an alternate directory, I’ve not found it yet. As such, I create the directory here, if it doesn’t exist, and make sure the www-data user has ownership of it.</li><li>I want to be able to log my PHP errors, so I create a log directory for PHP, and, again, make sure www-data can write to it.</li></ul></blockquote><p>Essentially, BeforeInstall is when I can make sure the system is ready to run my application once installation completes.</p><h4 id=private-configuration>Private configuration</h4><p>One other thing to note in that script is the usage of the AWS CLI to pull some files from S3:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c># Get private configuration</span>
<span class=k>if</span> <span class=o>[</span> <span class=o>!</span> <span class=nt>-d</span> <span class=s2>"/var/www/config"</span> <span class=o>]</span><span class=p>;</span><span class=k>then
    </span>mkdir <span class=nt>-p</span> /var/www/config
<span class=k>fi</span>
<span class=o>(</span><span class=nb>cd</span> /var/www/config <span class=o>&amp;&amp;</span> aws s3 sync s3://config.example.com .<span class=o>)</span>
</code></pre></div></div><p>What I’ve done here is stored production configuration settings and SSL certificates in a private bucket on S3. Because the AWS CLI needs appropriate credentials to access the bucket (and if you’re on an EC2 instance, it inherits credentials based on the instance policy), this is a safe operation, ensuring I have that data stored securely, and not in my git repository. I currently store my application production configuration there, as well as my SSL certificates. The lines above pull them from the bucket when I’m preparing to deploy, ensuring I have the latest production-ready versions.</p><h4 id=application-preparation>Application preparation</h4><p>With a PHP application, we likely want to wait to do anything until after our files have been moved to their installation directory. Why?</p><p>There are two reasons: location, and install quirks.</p><p>The first is that hook scripts appear to run with a working directory of <code class=highlighter-rouge>/opt/codedeploy-agent</code>, and not the deployment directory. When I tested, <code class=highlighter-rouge>composer install</code> and <code class=highlighter-rouge>npm install</code> both failed, due to being unable to locate their respective configuration… because they were running under <code class=highlighter-rouge>/opt/codedeploy-agent</code>.</p><p>You can, of course, figure out the current working directory from within bash with a few hurdles, and I tried that to make things work. However, that unveiled another issue: <em>CodeDeploy will only move directories that were originally part of the archive</em>. So, if you run <code class=highlighter-rouge>composer install</code> within a <code class=highlighter-rouge>BeforeInstall</code> script, the <code class=highlighter-rouge>vendor/</code> directory does not get moved to the installation directory.</p><p>As such, for most PHP projects, you’ll need to use an AfterInstall script to do your work. Moreover, you’ll need to have the script change the working directory to the installation directory.</p><p>So, as an example:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c>#!/bin/bash</span>
<span class=c>#######################################################################</span>
<span class=c># Application preparation</span>
<span class=c>#######################################################################</span>

<span class=o>(</span>
    <span class=nb>cd</span> /var/www/example.com <span class=p>;</span>

    <span class=c># Copy in the production local configuration</span>
    cp /var/www/config/php/<span class=k>*</span>.<span class=k>*</span> config/autoload/ <span class=p>;</span>

    <span class=c># Execute a composer installation</span>
    <span class=nv>COMPOSER_HOME</span><span class=o>=</span>/var/cache/composer composer install <span class=nt>--quiet</span> <span class=nt>--no-ansi</span> <span class=nt>--no-dev</span> <span class=nt>--no-interaction</span> <span class=nt>--no-progress</span> <span class=nt>--no-scripts</span> <span class=nt>--no-plugins</span> <span class=nt>--optimize-autoloader</span> <span class=p>;</span>

    <span class=c># Execute other scripts as needed ...</span>

    <span class=c># Compile CSS and JS</span>
    npm install <span class=p>;</span>
    grunt <span class=p>;</span>
    rm <span class=nt>-Rf</span> node_modules <span class=p>;</span>
<span class=o>)</span>
</code></pre></div></div><p>In the above:</p><ul><li>I copy my production configuration that I synced from S3 into my application.</li><li>I run Composer to install dependencies. Notice that I specify the composer cache directory I setup in by BeforeInstall script as the <code class=highlighter-rouge>COMPOSER_HOME</code>!</li><li>If I have other deployment/build tasks, I can run those.</li><li>In my case, I’m using grunt to aggregate and minimize CSS and JS assets, so I run that, and then clean-up after myself.</li></ul><p>The big thing to note is this construct:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=o>(</span>
    <span class=nb>cd</span> /var/www/example.com <span class=p>;</span>

    <span class=c># tasks..</span>
<span class=o>)</span>
</code></pre></div></div><p>Since this runs AfterInstall, I know the destination directory is ready, and I run my deployment operations there. The script itself, however, <em>is still being run from the CodeDeploy agent deployment directory</em>, which is why I need to change directories within my script.</p><h4 id=system-configuration>System configuration</h4><p>Now that the application has been prepared, we can update the system.</p><p>Some aspects of web applications that might change from one deployment to the next:</p><ul><li>Crontabs</li><li>SSL configuration</li><li>Web server configuration</li><li>PHP configuration</li></ul><p>You likely won’t want to update these, however, unless everything else during deployment has succeeded, so we do this <em>last</em>.</p><p>Here’s my system configuration script, <code class=highlighter-rouge>after-install-root.sh</code>:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c>#!/bin/bash</span>
<span class=c>#######################################################################</span>
<span class=c># System preparation following successful application installation.</span>
<span class=c>#######################################################################</span>

<span class=nv>SCRIPT_PATH</span><span class=o>=</span><span class=s2>"</span><span class=k>$(</span> <span class=nb>cd</span> <span class=s2>"</span><span class=k>$(</span> dirname <span class=s2>"</span><span class=k>${</span><span class=nv>BASH_SOURCE</span><span class=p>[0]</span><span class=k>}</span><span class=s2>"</span> <span class=k>)</span><span class=s2>"</span> <span class=o>&amp;&amp;</span> <span class=nb>pwd</span> <span class=k>)</span><span class=s2>"</span>
<span class=nv>CRONTAB_PATH</span><span class=o>=</span>/var/spool/cron/crontabs/www-data

<span class=c># Setup www-data crontab</span>
cp <span class=k>${</span><span class=nv>SCRIPT_PATH</span><span class=k>}</span>/crontab <span class=k>${</span><span class=nv>CRONTAB_PATH</span><span class=k>}</span> <span class=o>&amp;&amp;</span> chown www-data.crontab <span class=k>${</span><span class=nv>CRONTAB_PATH</span><span class=k>}</span> <span class=o>&amp;&amp;</span> chmod 600 <span class=k>${</span><span class=nv>CRONTAB_PATH</span><span class=k>}</span>

<span class=c># Bring in the SSL configuration and prep it</span>
mv /var/www/config/ssl/<span class=k>*</span>.<span class=k>*</span> /etc/ssl/
<span class=o>(</span><span class=nb>cd</span> /etc/ssl <span class=o>&amp;&amp;</span> <span class=nb>cat </span>example.com.crt example.com.ca-bundle <span class=o>&gt;</span> example.com.chained.crt<span class=o>)</span>

<span class=c># Copy nginx configuration</span>
cp <span class=k>${</span><span class=nv>SCRIPT_PATH</span><span class=k>}</span>/mwop.net.conf /etc/nginx/sites-available/
<span class=k>if</span> <span class=o>[</span> <span class=o>!</span> <span class=nt>-e</span> <span class=s2>"/etc/nginx/sites-enabled/example.com.conf"</span> <span class=o>]</span><span class=p>;</span><span class=k>then</span>
    <span class=o>(</span><span class=nb>cd</span> /etc/nginx/sites-enabled <span class=o>&amp;&amp;</span> ln <span class=nt>-s</span> ../sites-available/example.com.conf .<span class=o>)</span>
<span class=k>fi</span>

<span class=c># Copy php configuration for php-fpm process</span>
cp <span class=k>${</span><span class=nv>SCRIPT_PATH</span><span class=k>}</span>/php.ini /etc/php/7.0/fpm/conf.d/example.com.ini
cp <span class=k>${</span><span class=nv>SCRIPT_PATH</span><span class=k>}</span>/php-fpm.conf /etc/php/7.0/fpm/pool.d/www.conf
</code></pre></div></div><p>Again, this script runs in the context of the deployment directory, not the installation destination directory. Further, we need to copy files from it to various locations on the server, as well as from the files we downloaded via S3.</p><p>Crontabs have to be owned by the user, and the crontab group, and named after the user; I’d have loved to have been able to do this via the <code class=highlighter-rouge>appspec.yml</code> <code class=highlighter-rouge>files</code> configuration, but never found a combination that worked; as such, I do it here in the hook script.</p><blockquote><p>The above example assumes you’ve put some configuration files in your <code class=highlighter-rouge>.aws/</code> directory:</p><ul><li><code class=highlighter-rouge>php.ini</code>, with my production PHP settings.</li><li><code class=highlighter-rouge>php-fpm.conf</code>, with my production PHP-FPM configuration.</li><li><code class=highlighter-rouge>example.com.conf</code>, with my production nginx settings.</li></ul><p>I don’t detail what these files contain, as that will vary quite a bit between applications.</p></blockquote><p>The idea with this AfterInstall script is to ensure that we have appropriate server configuration to execute the current state of our application.</p><h4 id=application-start-and-stop>Application start and stop</h4><p>Remember when I mentioned earlier that all hook script <code class=highlighter-rouge>location</code> entries are relative to the deployment directory? This is where that information comes in.</p><p>When we start deployment, we need to stop any services we may be updating. For a PHP application, this is likely:</p><ul><li>The web server.</li><li>If you’re using php-fpm, then php-fpm.</li></ul><p>I originally tried this:</p><div class="language-yaml highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=na>hooks</span><span class=pi>:</span>
  <span class=na>ApplicationStop</span><span class=pi>:</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>service nginx stop</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
    <span class=pi>-</span> <span class=na>location</span><span class=pi>:</span> <span class=s>service php7.0-fpm stop</span>
      <span class=na>timeout</span><span class=pi>:</span> <span class=s>30</span>
      <span class=na>runas</span><span class=pi>:</span> <span class=s>root</span>
</code></pre></div></div><p>However, CodeDeploy was trying to resolve those as something along the lines of <code class=highlighter-rouge>/opt/codedeploy-agent/deployment/{some-uuid}/{deployment-id}/archive/service</code>.</p><p>So, the trick is to do those calls within a hook script you have in your repository. For example:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c>#!/bin/bash</span>
service nginx stop
service php7.0-fpm stop
</code></pre></div></div><p>Similarly, we want to bring the services back up during ApplicationStart:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=c>#!/bin/bash</span>
service php7.0-fpm start
service nginx start
service cron restart
</code></pre></div></div><p>(I also restart cron after installing the new crontab for www-data.)</p><h2 id=deployment>Deployment</h2><p>The first time you deploy, you’ll need to do it manually. Assuming you have installed and properly configured the AWS CLI on your own machine, and have setup CodeDeploy, you can do the following:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span>aws deploy create-deployment <span class=se>\</span>
<span class=o>&gt;</span> <span class=nt>--application-name</span> <span class=o>{</span>application-name<span class=o>}</span> <span class=se>\</span>
<span class=o>&gt;</span> <span class=nt>--deployment-group-name</span> <span class=o>{</span>deployment-group-name<span class=o>}</span> <span class=se>\</span>
<span class=o>&gt;</span> <span class=nt>--deployment-config-name</span> CodeDeployDefault.OneAtATime <span class=se>\</span>
<span class=o>&gt;</span> <span class=nt>--ignore-application-stop-failures</span> <span class=se>\</span>
<span class=o>&gt;</span> <span class=nt>--github-location</span> <span class=nv>repository</span><span class=o>={</span>user or org<span class=o>}</span>/<span class=o>{</span>repo<span class=o>}</span>,commitId<span class=o>={</span>sha1<span class=o>}</span>
</code></pre></div></div><p>Fill in all bracketed items with appropriate values.</p><blockquote><p>One thing to note from the original <code class=highlighter-rouge>create-deployment</code> command: the <code class=highlighter-rouge>--ignore--application-stop-failures</code> flag. This flag is necessary to ensure that deployment can continue if your ApplicationStop script fails. Why would you want this? Well, recall that we use BeforeInstall to setup our system dependencies. On our first execution, or on any execution where we add new services to start and stop, <em>you may have services that do not yet exist</em>. The point of the deployment is to install those! As such, use that flag!</p></blockquote><p>This will give you a JSON payload like the following:</p><div class="language-json highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=p>{</span><span class=w>
    </span><span class=s2>"deploymentId"</span><span class=p>:</span><span class=w> </span><span class=s2>"d-XXXXXXXXXX"</span><span class=w>
</span><span class=p>}</span><span class=w>
</span></code></pre></div></div><p>You can then check the status using:</p><div class="language-bash highlighter-rouge"><div class=highlight><pre class=highlight><code><span class=nv>$ </span>aws deploy get-deployment <span class=nt>--deployment-id</span> <span class=o>{</span>deploymentId<span class=o>}</span> <span class=nt>--query</span> <span class=s2>"deploymentInfo.[status,creator]"</span>
</code></pre></div></div><p>You can check that periodically, or pass it to the <code class=highlighter-rouge>watch</code> command to determine the status. If all goes well, you’ll see a <code class=highlighter-rouge>"status": "Succeeded"</code> message.</p><h3 id=troubleshooting>Troubleshooting</h3><p>If and/or when it fails, you have a couple places you can look.</p><p>If you go to the <a href=https://console.aws.amazon.com/codedeploy/home>CodeDeploy console on AWS</a>, you can drill down into your application and see the deployments. When a deployment fails, you’ll see a link to the deployment ID, which will take you an overview showing the instances to which it attempted to deploy. Each instance has a “View Events” link, which brings you to an overview of the events, and any failed events will have a link to logs.</p><p>You can also SSH to your server, and go to <code class=highlighter-rouge>/opt/codedeploy-agent/deployment-root/{some uuid}/</code>. Do an <code class=highlighter-rouge>ls -ltr | tail -n1</code> to find the latest deployment ID, and then descend into it. In that directory, you can then do a <code class=highlighter-rouge>less logs/scripts.log</code>, and usually discover what the error is. (This was how I discovered the issues with where and how the hook scripts are executed, as well as the issues with Composer and npm that I ended up working around.)</p><h2 id=automation>Automation</h2><p>AWS has an official AWS CodeDeploy webhook for GitHub that can be used along with the GitHub Auto-Deployment webhook. Once you have confirmed that you can create successful deployments, you can wire these up.</p><p>The AWS blog has <a href=https://blogs.aws.amazon.com/application-management/post/Tx33XKAKURCCW83/Automatically-Deploy-from-GitHub-Using-AWS-CodeDeploy>an excellent guide to setting up autodeployment</a>; I have nothing I can add to that. I followed the instructions once I had a working deployment, and it all <em>just worked</em>.</p><h2 id=summary>Summary</h2><p>AWS CodeDeploy is quite powerful, and, once you understand its quirks, is a solid approach to deployment; it essentially allows you to create a custom PaaS for your application with “push to deploy”, and ensures that each deployment is setup based on the current production requirements.</p><p>While this post detailed using a single EC2 node, you can also setup multiple instances under the same policy; when CodeDeploy triggers a deployment, it will only succeed once all nodes have successfully deployed. As such, it even provides a path to horizontal scaling!</p><p>I’m really happy with the results, despite the amount of trial-and-error it took to get things working. Hopefully this post will help reduce the amount of time others need to make this powerful tool work for them!</p></div></section><div class=row><div class="col-xs-12 col-sm-6"><div class=post-comments><a class="btn btn-primary" href=http://julien.guittard.io/blog/push-to-deploy-with-aws-codedeploy.html#disqus_thread data-disqus-identifier=/blog/push-to-deploy-with-aws-codedeploy.html></a></div></div><div class="col-xs-12 col-sm-6"><div class=social-icons><a href="https://facebook.com/sharer.php?u=http://julien.guittard.io/blog/push-to-deploy-with-aws-codedeploy.html" rel=nofollow target=_blank title="Share on Facebook" class=social-icons__container><span class=zocial-facebook></span></a> <a href="https://twitter.com/intent/tweet?text=Push-to-Deploy with AWS CodeDeploy&url=http://julien.guittard.io/blog/push-to-deploy-with-aws-codedeploy.html&via=julienguittard" rel=nofollow target="
            " title="Share on Twitter" class=social-icons__container><span class=zocial-twitter></span></a> <a href="https://plus.google.com/share?url=http://julien.guittard.io/blog/push-to-deploy-with-aws-codedeploy.html" rel=nofollow target=_blank title="Share on Google" class=social-icons__container><span class=zocial-google></span></a></div></div></div><div class=row><div class="col-xs-12 col-sm-6"><div class=post-author id=author-box role=contentinfo itemprop=author itemscope itemtype=http://schema.org/Person><h6>Written By</h6><hr><figure itemprop=image itemscope itemtype=http://schema.org/ImageObject><img src="https://avatars1.githubusercontent.com/u/25943?s=90&v=4" alt="Author avatar" itemprop=contenturl><meta itemprop=url content="https://avatars1.githubusercontent.com/u/25943?s=90&v=4"><meta itemprop=width content=90><meta itemprop=height content=90></figure><h5><a href=https://mwop.net itemprop=url><span itemprop=name>Matthew Weier O'Phinney</span></a></h5><span class=post-author__text></span></div></div><div class="col-xs-12 col-sm-6"><div class=tags><h6>Tags</h6><meta itemprop=keywords content="aws, devops, php, programming"><hr><a href=/blog/tags/aws/ class=tags__link rel=tag>aws</a> <a href=/blog/tags/devops/ class=tags__link rel=tag>devops</a> <a href=/blog/tags/php/ class=tags__link rel=tag>php</a> <a href=/blog/tags/programming/ class=tags__link rel=tag>programming</a></div></div></div><div class="disqus-comments push-down-45"><div id=disqus_thread></div><script>var disqus_shortname="julienguittard",disqus_config=function(){this.page.url="http://julien.guittard.io/blog/push-to-deploy-with-aws-codedeploy.html",this.page.identifier="push-to-deploy-with-aws-codedeploy",this.page.title="Push-to-Deploy with AWS CodeDeploy"};!function(){var t=document,e=t.createElement("script");e.src="//"+disqus_shortname+".disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript rel=nofollow>comments powered by Disqus.</a></noscript></div><div class=related-stories><h6>Related Stories</h6><hr></div></div></div></article></div><footer class=footer role=contentinfo><div class=container><div class="col-xs-12 col-md-3"><div class="widget-about push-down-30"><img src=http://julien.guittard.io/images/logo.png alt=Logo width=176 height=70><br><span class=footer__text>Hi, I'm Julien Guittard, welcome to my personal website. I am a web application architect and trainer.</span><br><br><div class="social-icons widget-social-icons"><a href=https://www.twitter.com/julienguittard class=social-icons__container title="Follow me on Twitter"><span class=zocial-twitter></span> </a><a href=https://www.linkedin.com/in/julienguittard class=social-icons__container title="Hire me on LinkedIn"><span class=zocial-linkedin></span> </a><a href=https://github.com/jguittard class=social-icons__container title="Clone me on Github"><span class=zocial-github></span> </a><a href=/feed.xml class=social-icons__container title="Read me through RSS"><span class=zocial-rss></span></a></div></div></div><div class="col-xs-12 col-md-3"><div class="tags widget-tags"><h6>Tags</h6><hr><a href=/blog/tags/:tag/http class=tags__link rel=tag>http</a> <a href=/blog/tags/:tag/middleware class=tags__link rel=tag>middleware</a> <a href=/blog/tags/:tag/php class=tags__link rel=tag>php</a> <a href=/blog/tags/:tag/programming class=tags__link rel=tag>programming</a> <a href=/blog/tags/:tag/psr-7 class=tags__link rel=tag>psr-7</a></div></div><div class="col-xs-12 col-md-3"><div class="widget-navigation push-down-30"><h6>Navigation</h6><hr><ul class=navigation><li><a href=http://julien.guittard.io/ >Home</a></li><li><a href=http://julien.guittard.io/blog/ >Blog</a></li><li><a href=http://julien.guittard.io/about-me/ >About me</a></li><li><a href=http://julien.guittard.io/contact/ >Contact</a></li></ul></div></div><div class="col-xs-12 col-md-3"><div class="widget-contact push-down-30"><h6>Contact</h6><hr></div></div></div></footer><section class=copyrights><div class=container><div class=row><div class="col-xs-12 col-sm-6">Copyright 2009-2018 &copy; by Julien Guittard.</div><div class="col-xs-12 col-sm-6"><div class=copyrights--right>Made with <i class="glyphicon glyphicon-heart"></i> using <a href=https://jekyllrb.com/ target=_blank>Jekyll</a> and <a href=https://pages.github.com target=_blank>Github Pages</a>.</div></div></div></div></section><script src=http://julien.guittard.io/jquery/dist/jquery.js charset=utf-8></script><script src=http://julien.guittard.io/sass-bootstrap/dist/js/bootstrap.js charset=utf-8></script><script src=http://julien.guittard.io/underscore/underscore.js charset=utf-8></script><script src=http://julien.guittard.io/scripts/main.js></script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-65618920-1","auto"),ga("send","pageview")</script><script id=dsq-count-scr src=//julienguittard.disqus.com/count.js async></script></body></html>